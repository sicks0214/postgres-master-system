# PostgreSQLæ€»ç³»ç»Ÿ - å®Œæ•´ä½¿ç”¨æŒ‡å—

## ğŸ“¦ ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**å®Œå…¨ç‹¬ç«‹**çš„PostgreSQLæ€»ç³»ç»Ÿæ–‡ä»¶å¤¹ï¼Œå¯ä»¥**å•ç‹¬æ‹·è´**åˆ°ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼Œæ”¯æŒï¼š

- âœ… **æœ¬åœ°æµ‹è¯•**ï¼šåœ¨æœ¬åœ°Windows/Mac/Linuxä¸Šå®Œæ•´éªŒè¯
- âœ… **VPSéƒ¨ç½²**ï¼šä¸€é”®éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- âœ… **å¤šç«™ç‚¹æ”¯æŒ**ï¼šæ”¯æŒ20ä¸ªç«™ç‚¹å…±äº«åŒä¸€ä¸ªPostgreSQLå®ä¾‹
- âœ… **å®Œæ•´éš”ç¦»**ï¼šä¸ç°æœ‰ç¨‹åºå®Œå…¨ç‹¬ç«‹ï¼Œä¸å½±å“ç°æœ‰ä»£ç 

---

## ğŸ“ æ–‡ä»¶å¤¹ç»“æ„

```
postgres-master-system/               # ç‹¬ç«‹çš„PostgreSQLç³»ç»Ÿæ–‡ä»¶å¤¹
â”‚
â”œâ”€â”€ README.md                         # ğŸ“– å®Œæ•´æ–‡æ¡£ï¼ˆæ¨èå…ˆé˜…è¯»ï¼‰
â”œâ”€â”€ QUICKSTART.md                     # ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹
â”œâ”€â”€ CHANGELOG.md                      # ğŸ“ æ›´æ–°æ—¥å¿—
â”œâ”€â”€ ä½¿ç”¨æŒ‡å—-å®Œæ•´ç‰ˆ.md                 # ğŸ“˜ æœ¬æ–‡ä»¶
â”‚
â”œâ”€â”€ docker-compose.local.yml          # ğŸ  æœ¬åœ°æµ‹è¯•é…ç½®
â”œâ”€â”€ docker-compose.vps.yml            # ğŸš€ VPSç”Ÿäº§é…ç½®
â”œâ”€â”€ .gitignore                        # å¿½ç•¥æ–‡ä»¶é…ç½®
â”‚
â”œâ”€â”€ init-scripts/                     # ğŸ“‚ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
â”‚   â”œâ”€â”€ 01_unified_feedback.sql       # ç»Ÿä¸€åé¦ˆè¡¨
â”‚   â”œâ”€â”€ 02_site4_colormagic.sql       # Site4 (ColorMagic) ä¸“ç”¨è¡¨
â”‚   â””â”€â”€ 03_sites_and_functions.sql    # å…¶ä»–ç«™ç‚¹ç”¨æˆ·å’Œç³»ç»Ÿå‡½æ•°
â”‚
â”œâ”€â”€ scripts/                          # ğŸ“‚ ç®¡ç†è„šæœ¬
â”‚   â”œâ”€â”€ local-start.bat               # Windowsæœ¬åœ°å¯åŠ¨
â”‚   â”œâ”€â”€ local-start.sh                # Linux/Macæœ¬åœ°å¯åŠ¨
â”‚   â”œâ”€â”€ local-verify.bat              # Windowsæœ¬åœ°éªŒè¯
â”‚   â”œâ”€â”€ local-verify.sh               # Linux/Macæœ¬åœ°éªŒè¯
â”‚   â””â”€â”€ export-to-vps.sh              # å¯¼å‡ºåˆ°VPSè„šæœ¬
â”‚
â””â”€â”€ backups/                          # ğŸ“‚ å¤‡ä»½æ–‡ä»¶ç›®å½•
    â””â”€â”€ .gitkeep

æ€»è®¡ï¼š16ä¸ªæ–‡ä»¶ï¼Œ3ä¸ªæ–‡ä»¶å¤¹
```

---

## ğŸ¯ ä¸‰ç§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæœ¬åœ°æµ‹è¯•éªŒè¯ï¼ˆæ¨èå…ˆåšï¼‰

**ç›®çš„**ï¼šåœ¨æœ¬åœ°å®Œæ•´éªŒè¯PostgreSQLç³»ç»Ÿï¼Œç¡®ä¿æ‰€æœ‰è¡¨å’Œæƒé™é…ç½®æ­£ç¡®

**Windowsæ“ä½œæ­¥éª¤**ï¼š

```cmd
# 1. å¤åˆ¶æ–‡ä»¶å¤¹åˆ°æœ¬åœ°æµ‹è¯•ç›®å½•
xcopy /E /I postgres-master-system C:\test-postgres

# 2. è¿›å…¥æµ‹è¯•ç›®å½•
cd C:\test-postgres

# 3. å¯åŠ¨PostgreSQL
scripts\local-start.bat

# 4. ç­‰å¾…15ç§’åéªŒè¯
scripts\local-verify.bat
```

**Linux/Macæ“ä½œæ­¥éª¤**ï¼š

```bash
# 1. å¤åˆ¶æ–‡ä»¶å¤¹åˆ°æœ¬åœ°æµ‹è¯•ç›®å½•
cp -r postgres-master-system ~/test-postgres

# 2. è¿›å…¥æµ‹è¯•ç›®å½•
cd ~/test-postgres

# 3. èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# 4. å¯åŠ¨PostgreSQL
./scripts/local-start.sh

# 5. ç­‰å¾…15ç§’åéªŒè¯
./scripts/local-verify.sh
```

**éªŒè¯æˆåŠŸæ ‡å¿—**ï¼š

```
âœ… æ‰€æœ‰éªŒè¯æµ‹è¯•å®Œæˆ - ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
   æˆåŠŸ: 8/8
   å¤±è´¥: 0/8

ğŸ“ ç³»ç»Ÿç»Ÿè®¡:
{
  "systemName": "PostgreSQLæ€»ç³»ç»Ÿ",
  "version": "2.0",
  "totalSites": 1,
  "totalFeedbacks": 3,
  "colormagic": {
    "users": 1,
    "analyses": 0,
    "palettes": 1,
    "exports": 0
  }
}
```

---

### åœºæ™¯2ï¼šæ‰“åŒ…ä¸Šä¼ åˆ°VPS

**ç›®çš„**ï¼šå°†æœ¬åœ°éªŒè¯æˆåŠŸçš„ç³»ç»Ÿéƒ¨ç½²åˆ°VPSç”Ÿäº§ç¯å¢ƒ

**æ­¥éª¤1ï¼šæœ¬åœ°æ‰“åŒ…**

```bash
# è¿›å…¥ç³»ç»Ÿç›®å½•
cd postgres-master-system

# è¿è¡Œå¯¼å‡ºè„šæœ¬ï¼ˆLinux/Macï¼‰
./scripts/export-to-vps.sh

# Windowsç”¨æˆ·æ‰‹åŠ¨æ‰“åŒ…
# å‹ç¼©æ•´ä¸ª postgres-master-system æ–‡ä»¶å¤¹ä¸º .tar.gz æˆ– .zip
```

**æ­¥éª¤2ï¼šä¸Šä¼ åˆ°VPS**

```bash
# ä¸Šä¼ åˆ°VPS
scp export-to-vps/postgres-master-system.tar.gz root@YOUR_VPS_IP:/tmp/

# æˆ–ä½¿ç”¨å…¶ä»–å·¥å…·ï¼ˆFTPã€SFTPã€å®å¡”ç­‰ï¼‰ä¸Šä¼ 
```

**æ­¥éª¤3ï¼šVPSä¸Šéƒ¨ç½²**

```bash
# SSHåˆ°VPS
ssh root@YOUR_VPS_IP

# åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p /docker/db_master
cd /docker/db_master

# è§£å‹
tar -xzf /tmp/postgres-master-system.tar.gz

# âš ï¸ é‡è¦ï¼šä¿®æ”¹ç”Ÿäº§å¯†ç 
nano init-scripts/02_site4_colormagic.sql
# å°† ColorMagic_Local_Test_Pass æ”¹ä¸º ColorMagic_VPS_2024_Secure_Pass

nano init-scripts/03_sites_and_functions.sql
# å°† site%s_test_pass æ”¹ä¸º site%s_pass

# åˆ›å»ºDockerç½‘ç»œ
docker network create shared_net 2>/dev/null || true

# å¯åŠ¨PostgreSQL
docker compose -f docker-compose.vps.yml up -d

# ç­‰å¾…åˆå§‹åŒ–
sleep 20

# æŸ¥çœ‹æ—¥å¿—
docker logs postgres_master --tail 50

# éªŒè¯éƒ¨ç½²
docker exec postgres_master psql -U admin -d postgres -c "SELECT get_system_stats();"
```

---

### åœºæ™¯3ï¼šåº”ç”¨æ¥å…¥PostgreSQLç³»ç»Ÿ

**ç›®çš„**ï¼šè®©Site4 (ColorMagic) åº”ç”¨è¿æ¥åˆ°PostgreSQLæ€»ç³»ç»Ÿ

#### 3.1 åº”ç”¨ç¯å¢ƒå˜é‡é…ç½®

ç¼–è¾‘åº”ç”¨çš„ `.env` æ–‡ä»¶ï¼š

```bash
# /docker/site4/backend/.env

# ============================================
# PostgreSQLæ€»ç³»ç»Ÿè¿æ¥é…ç½®
# ============================================
USE_DATABASE=true
DB_HOST=postgres_master          # Dockerç½‘ç»œåˆ«åï¼ˆä¸æ˜¯å®¹å™¨IDï¼‰
DB_PORT=5432
DB_NAME=postgres
DB_USER=colormagic_user
DB_PASSWORD=ColorMagic_VPS_2024_Secure_Pass
DB_SSL=false
DB_MAX_CONNECTIONS=20

# ç«™ç‚¹æ ‡è¯†ï¼ˆç”¨äºunified_feedbackè¡¨ï¼‰
SITE_ID=colormagic

# ============================================
# å…¶ä»–é…ç½®
# ============================================
NODE_ENV=production
PORT=3000
JWT_SECRET=your-super-secret-jwt-key
ALLOWED_ORIGINS=https://imagecolorpicker.cc,https://www.imagecolorpicker.cc
```

#### 3.2 åº”ç”¨Dockeré…ç½®

ç¡®ä¿åº”ç”¨å®¹å™¨è¿æ¥åˆ° `shared_net` ç½‘ç»œï¼š

```bash
# æ–¹å¼1ï¼šdocker runï¼ˆæ‰‹åŠ¨å¯åŠ¨ï¼‰
docker run -d --name site4 \
  --network shared_net \
  --env-file backend/.env \
  your-image:latest

# æ–¹å¼2ï¼šdocker-compose.ymlï¼ˆæ¨èï¼‰
# åœ¨åº”ç”¨çš„docker-compose.ymlä¸­æ·»åŠ ï¼š
services:
  site4:
    image: your-image
    networks:
      - shared_net
    environment:
      - USE_DATABASE=true
      - DB_HOST=postgres_master
    # ... å…¶ä»–é…ç½®

networks:
  shared_net:
    external: true
```

#### 3.3 ä»£ç é€‚é…

**é‡è¦ï¼šè¡¨åéœ€è¦ä¸PostgreSQLç³»ç»Ÿä¸­çš„è¡¨åä¸€è‡´**

| ä»£ç ä¸­å¯èƒ½çš„è¡¨å | PostgreSQLå®é™…è¡¨å | è¯´æ˜ |
|-----------------|-------------------|------|
| `users` | `colormagic_users` | ç”¨æˆ·è¡¨ |
| `user_sessions` | `colormagic_sessions` | ä¼šè¯è¡¨ |
| `user_analysis_history` | `colormagic_analysis_history` | ç”¨æˆ·åˆ†æå†å² |
| `user_favorite_palettes` | `colormagic_palettes` | æ”¶è—è°ƒè‰²æ¿ |
| `user_usage_stats` | `colormagic_usage_stats` | ä½¿ç”¨ç»Ÿè®¡ |
| `analysis_history` | `colormagic_color_analysis` | é¢œè‰²åˆ†æè®°å½• |
| `export_history` | `colormagic_export_history` | å¯¼å‡ºå†å² |
| `unified_feedback` | `unified_feedback` | åé¦ˆè¡¨ï¼ˆä½¿ç”¨site_id='colormagic'ï¼‰ |

**æ£€æŸ¥ä»£ç ä¸­çš„SQLè¯­å¥**ï¼š

```typescript
// âŒ é”™è¯¯ï¼šä½¿ç”¨æ—§è¡¨å
const query = 'SELECT * FROM users WHERE id = $1';

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ–°è¡¨å
const query = 'SELECT * FROM colormagic_users WHERE id = $1';
```

**æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®è¡¨å‰ç¼€**ï¼š

```typescript
// config/database.ts
const TABLE_PREFIX = process.env.TABLE_PREFIX || 'colormagic_';

const getUserQuery = `SELECT * FROM ${TABLE_PREFIX}users WHERE id = $1`;
```

#### 3.4 éªŒè¯åº”ç”¨è¿æ¥

```bash
# 1. æ£€æŸ¥åº”ç”¨å®¹å™¨ç½‘ç»œ
docker inspect site4 | grep -A 10 "Networks"

# 2. æµ‹è¯•DNSè§£æ
docker exec site4 ping -c 2 postgres_master

# 3. æµ‹è¯•ç«¯å£è¿æ¥
docker exec site4 nc -zv postgres_master 5432

# 4. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼ˆç¡®è®¤æ•°æ®åº“è¿æ¥ï¼‰
docker logs site4 | grep -i database

# 5. æµ‹è¯•åº”ç”¨API
curl http://localhost:3000/health
curl http://localhost:3000/api/feedback/health
```

---

## ğŸ” éªŒè¯æ£€æŸ¥æ¸…å•

### PostgreSQLç³»ç»Ÿæ£€æŸ¥

```bash
# âœ… 1. å®¹å™¨è¿è¡Œ
docker ps | grep postgres_master
# é¢„æœŸï¼šçœ‹åˆ°postgres_masterå®¹å™¨åœ¨è¿è¡Œ

# âœ… 2. æ•°æ®åº“ç‰ˆæœ¬
docker exec postgres_master psql -U admin -d postgres -c "SELECT version();"
# é¢„æœŸï¼šPostgreSQL 15.x

# âœ… 3. ç³»ç»Ÿç»Ÿè®¡
docker exec postgres_master psql -U admin -d postgres -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"
# é¢„æœŸï¼šè¿”å›å®Œæ•´çš„JSONç»Ÿè®¡æ•°æ®

# âœ… 4. è¡¨åˆ—è¡¨
docker exec postgres_master psql -U admin -d postgres -c "\dt"
# é¢„æœŸï¼šçœ‹åˆ°8-10ä¸ªè¡¨ï¼ˆunified_feedback + colormagic_*ï¼‰

# âœ… 5. ColorMagicè¡¨
docker exec postgres_master psql -U admin -d postgres -c "\dt colormagic_*"
# é¢„æœŸï¼šçœ‹åˆ°7ä¸ªcolormagic_å¼€å¤´çš„è¡¨

# âœ… 6. ç”¨æˆ·åˆ—è¡¨
docker exec postgres_master psql -U admin -d postgres -c "\du"
# é¢„æœŸï¼šçœ‹åˆ°admin + colormagic_user + site1_user ~ site20_user

# âœ… 7. ColorMagicç”¨æˆ·è¿æ¥
docker exec postgres_master psql -U colormagic_user -d postgres -c "SELECT current_user;"
# é¢„æœŸï¼šè¿”å› colormagic_user

# âœ… 8. ColorMagicç”¨æˆ·æƒé™
docker exec postgres_master psql -U colormagic_user -d postgres -c "SELECT COUNT(*) FROM colormagic_users;"
# é¢„æœŸï¼šè¿”å›æ•°å­—ï¼ˆè‡³å°‘1ï¼‰

# âœ… 9. æ’å…¥æµ‹è¯•åé¦ˆ
docker exec postgres_master psql -U colormagic_user -d postgres -c "
INSERT INTO unified_feedback (site_id, content, category) 
VALUES ('colormagic', 'ç³»ç»ŸéªŒè¯æµ‹è¯•', 'test') 
RETURNING id, site_id, content;
"
# é¢„æœŸï¼šè¿”å›æ’å…¥çš„è®°å½•

# âœ… 10. æŸ¥è¯¢åé¦ˆ
docker exec postgres_master psql -U colormagic_user -d postgres -c "
SELECT id, site_id, LEFT(content, 30) as content, created_at 
FROM unified_feedback 
WHERE site_id = 'colormagic' 
ORDER BY created_at DESC 
LIMIT 3;
"
# é¢„æœŸï¼šçœ‹åˆ°æœ€è¿‘çš„3æ¡åé¦ˆè®°å½•
```

### åº”ç”¨æ¥å…¥æ£€æŸ¥

```bash
# âœ… 1. åº”ç”¨å®¹å™¨è¿è¡Œ
docker ps | grep site4

# âœ… 2. åº”ç”¨ç½‘ç»œè¿æ¥
docker network inspect shared_net | grep -A 3 site4
docker network inspect shared_net | grep -A 3 postgres

# âœ… 3. DNSè§£æ
docker exec site4 ping -c 2 postgres_master
# é¢„æœŸï¼šèƒ½å¤Ÿè§£æå¹¶pingé€š

# âœ… 4. ç«¯å£è¿æ¥
docker exec site4 nc -zv postgres_master 5432
# é¢„æœŸï¼šConnection succeeded

# âœ… 5. ç¯å¢ƒå˜é‡
docker exec site4 env | grep -E '(DB_HOST|DB_USER|DB_PASSWORD)'
# é¢„æœŸï¼šçœ‹åˆ°æ­£ç¡®çš„æ•°æ®åº“é…ç½®

# âœ… 6. åº”ç”¨æ—¥å¿—
docker logs site4 --tail 50 | grep -i database
# é¢„æœŸï¼šçœ‹åˆ°æ•°æ®åº“è¿æ¥æˆåŠŸçš„æ—¥å¿—

# âœ… 7. å¥åº·æ£€æŸ¥
curl http://localhost:3000/health
# é¢„æœŸï¼š{"status":"ok"}

# âœ… 8. åé¦ˆAPIå¥åº·æ£€æŸ¥
curl http://localhost:3000/api/feedback/health
# é¢„æœŸï¼š{"success":true,"service":"Feedback Service"}
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šæœ¬åœ°ç«¯å£5432å†²çª

**ç—‡çŠ¶**ï¼šå¯åŠ¨å¤±è´¥ï¼Œæç¤ºç«¯å£è¢«å ç”¨

**è§£å†³**ï¼š
```bash
# æœ¬åœ°æµ‹è¯•å·²è‡ªåŠ¨ä½¿ç”¨5433ç«¯å£
# å¦‚æœä»æœ‰å†²çªï¼Œä¿®æ”¹ docker-compose.local.yml:
ports:
  - "5434:5432"  # æ”¹ä¸º5434æˆ–å…¶ä»–ç«¯å£
```

### é—®é¢˜2ï¼šåº”ç”¨æ— æ³•è¿æ¥postgres_master

**ç—‡çŠ¶**ï¼š`getaddrinfo ENOTFOUND postgres_master`

**æ£€æŸ¥**ï¼š
```bash
# 1. ç¡®è®¤shared_netç½‘ç»œå­˜åœ¨
docker network ls | grep shared_net

# 2. ç¡®è®¤postgreså®¹å™¨åœ¨shared_netä¸­
docker network inspect shared_net | grep postgres

# 3. ç¡®è®¤åº”ç”¨å®¹å™¨åœ¨shared_netä¸­
docker network inspect shared_net | grep site4
```

**è§£å†³**ï¼š
```bash
# é‡æ–°è¿æ¥ç½‘ç»œ
docker network disconnect shared_net site4 2>/dev/null || true
docker network connect shared_net site4
```

### é—®é¢˜3ï¼šå¯†ç è®¤è¯å¤±è´¥

**ç—‡çŠ¶**ï¼š`password authentication failed for user "colormagic_user"`

**æ£€æŸ¥**ï¼š
```bash
# 1. æŸ¥çœ‹åº”ç”¨.envä¸­çš„å¯†ç 
cat /docker/site4/backend/.env | grep DB_PASSWORD

# 2. æµ‹è¯•å¯†ç æ˜¯å¦æ­£ç¡®
PGPASSWORD='YourPassword' docker exec postgres_master psql -U colormagic_user -d postgres -c "SELECT current_user;"
```

**è§£å†³**ï¼š
```bash
# æ–¹å¼1ï¼šé‡ç½®PostgreSQLä¸­çš„å¯†ç 
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER colormagic_user WITH PASSWORD 'NewPassword123';
"

# æ–¹å¼2ï¼šæ›´æ–°åº”ç”¨.envæ–‡ä»¶
nano /docker/site4/backend/.env
# ä¿®æ”¹ DB_PASSWORD=NewPassword123

# é‡å¯åº”ç”¨å®¹å™¨ï¼ˆé‡è¦ï¼ï¼‰
docker stop site4 && docker rm site4
docker compose up -d
```

### é—®é¢˜4ï¼šè¡¨ä¸å­˜åœ¨

**ç—‡çŠ¶**ï¼š`relation "colormagic_users" does not exist`

**åŸå› **ï¼š
- åˆå§‹åŒ–è„šæœ¬æœªæ‰§è¡Œï¼ˆDockerå·å·²å­˜åœ¨æ•°æ®ï¼‰
- è¡¨åä¸åŒ¹é…

**è§£å†³**ï¼š
```bash
# æ–¹å¼1ï¼šå®Œå…¨é‡æ–°åˆå§‹åŒ–
docker compose down -v  # -v ä¼šåˆ é™¤æ•°æ®å·
docker compose -f docker-compose.vps.yml up -d

# æ–¹å¼2ï¼šæ‰‹åŠ¨æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
cat init-scripts/02_site4_colormagic.sql | \
  docker exec -i postgres_master psql -U admin -d postgres

# æ–¹å¼3ï¼šæ£€æŸ¥è¡¨æ˜¯å¦ä»¥å…¶ä»–åå­—å­˜åœ¨
docker exec postgres_master psql -U admin -d postgres -c "\dt"
```

### é—®é¢˜5ï¼šåº”ç”¨å¯åŠ¨åæ•°æ®åº“è¿æ¥æ± è€—å°½

**ç—‡çŠ¶**ï¼š`remaining connection slots are reserved`

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹å½“å‰è¿æ¥æ•°
docker exec postgres_master psql -U admin -d postgres -c "
SELECT count(*) as connections, usename 
FROM pg_stat_activity 
GROUP BY usename;
"
```

**è§£å†³**ï¼š
```bash
# 1. å¢åŠ max_connectionsï¼ˆåœ¨docker-compose.vps.ymlä¸­å·²è®¾ç½®ä¸º200ï¼‰

# 2. å‡å°‘åº”ç”¨çš„è¿æ¥æ± å¤§å°ï¼ˆåœ¨åº”ç”¨.envä¸­ï¼‰
DB_MAX_CONNECTIONS=10  # æ”¹å°ä¸€äº›

# 3. æ¸…ç†ç©ºé—²è¿æ¥
docker exec postgres_master psql -U admin -d postgres -c "
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'idle' AND state_change < now() - interval '5 minutes';
"
```

---

## ğŸ“Š ç³»ç»Ÿç›‘æ§

### å®æ—¶ç›‘æ§å‘½ä»¤

```bash
# 1. å®æ—¶æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡ï¼ˆæ¯5ç§’åˆ·æ–°ï¼‰
watch -n 5 'docker exec postgres_master psql -U admin -d postgres -t -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"'

# 2. æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker logs postgres_master -f

# 3. æŸ¥çœ‹æ´»è·ƒè¿æ¥
docker exec postgres_master psql -U admin -d postgres -c "
SELECT usename, application_name, client_addr, state, query_start, query 
FROM pg_stat_activity 
WHERE state = 'active' 
ORDER BY query_start;
"

# 4. æŸ¥çœ‹è¡¨å¤§å°
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY size_bytes DESC;
"

# 5. æŸ¥çœ‹æ•°æ®åº“å¤§å°
docker exec postgres_master psql -U admin -d postgres -c "
SELECT pg_database.datname, pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;
"
```

### åˆ›å»ºç›‘æ§è„šæœ¬

```bash
# åˆ›å»ºç®€å•çš„ç›‘æ§è„šæœ¬
cat > /docker/db_master/monitor.sh << 'EOF'
#!/bin/bash
echo "=========================================="
echo "PostgreSQLæ€»ç³»ç»Ÿ - ç³»ç»Ÿç›‘æ§"
echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="
echo ""

echo "ğŸ“Š ç³»ç»Ÿç»Ÿè®¡:"
docker exec postgres_master psql -U admin -d postgres -t -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"

echo ""
echo "ğŸ”— æ´»è·ƒè¿æ¥æ•°:"
docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT usename, COUNT(*) as connections 
FROM pg_stat_activity 
GROUP BY usename 
ORDER BY connections DESC;
"

echo ""
echo "ğŸ’¾ æ•°æ®åº“å¤§å°:"
docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT pg_size_pretty(pg_database_size('postgres'));
"

echo ""
echo "=========================================="
EOF

chmod +x /docker/db_master/monitor.sh

# ä½¿ç”¨ç›‘æ§è„šæœ¬
/docker/db_master/monitor.sh
```

---

## ğŸ’¾ å¤‡ä»½å’Œæ¢å¤

### è‡ªåŠ¨å¤‡ä»½

```bash
# åˆ›å»ºè‡ªåŠ¨å¤‡ä»½è„šæœ¬
cat > /docker/db_master/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/docker/db_master/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å…¨åº“å¤‡ä»½
docker exec postgres_master pg_dumpall -U admin | \
  gzip > $BACKUP_DIR/postgres_full_${DATE}.sql.gz

# åªä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR/postgres_full_${DATE}.sql.gz"
ls -lh $BACKUP_DIR | tail -5
EOF

chmod +x /docker/db_master/backup.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½ï¼‰
crontab -e
# æ·»åŠ è¿™ä¸€è¡Œï¼š
# 0 3 * * * /docker/db_master/backup.sh >> /docker/db_master/backup.log 2>&1
```

### æ‰‹åŠ¨å¤‡ä»½

```bash
# 1. å…¨åº“å¤‡ä»½
docker exec postgres_master pg_dumpall -U admin | \
  gzip > backup_$(date +%Y%m%d).sql.gz

# 2. åªå¤‡ä»½ColorMagicè¡¨
docker exec postgres_master pg_dump -U admin -d postgres \
  -t 'colormagic_*' -t 'unified_feedback' | \
  gzip > colormagic_backup_$(date +%Y%m%d).sql.gz

# 3. åªå¤‡ä»½ç»“æ„ï¼ˆä¸å«æ•°æ®ï¼‰
docker exec postgres_master pg_dumpall -U admin --schema-only > \
  schema_$(date +%Y%m%d).sql
```

### æ¢å¤æ•°æ®

```bash
# 1. æ¢å¤å®Œæ•´å¤‡ä»½
gunzip -c backup_20241002.sql.gz | \
  docker exec -i postgres_master psql -U admin -d postgres

# 2. æ¢å¤å•ä¸ªè¡¨
cat colormagic_backup_20241002.sql | \
  docker exec -i postgres_master psql -U admin -d postgres

# 3. æ¢å¤å‰å…ˆåœæ­¢åº”ç”¨
docker stop site4
# æ¢å¤...
docker start site4
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

```bash
# ä¿®æ”¹adminå¯†ç 
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER admin WITH PASSWORD 'YourStrongPassword123!@#';
"

# ä¿®æ”¹colormagic_userå¯†ç 
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER colormagic_user WITH PASSWORD 'YourStrongPassword456!@#';
"

# åŒæ—¶æ›´æ–°åº”ç”¨çš„.envæ–‡ä»¶
nano /docker/site4/backend/.env
```

### 2. é™åˆ¶è¿œç¨‹è®¿é—®

```yaml
# ç¼–è¾‘ docker-compose.vps.yml
# æ–¹å¼1ï¼šå®Œå…¨ç¦ç”¨å¤–éƒ¨è®¿é—®ï¼ˆæ¨èï¼‰
# ports:
#   - "5432:5432"  # æ³¨é‡Šæ‰

# æ–¹å¼2ï¼šåªå…è®¸æœ¬åœ°è®¿é—®
ports:
  - "127.0.0.1:5432:5432"
```

### 3. ä½¿ç”¨SSLè¿æ¥

```yaml
# docker-compose.vps.yml æ·»åŠ SSLé…ç½®
environment:
  - POSTGRES_SSL=on
volumes:
  - ./ssl/server.crt:/var/lib/postgresql/server.crt
  - ./ssl/server.key:/var/lib/postgresql/server.key

# åº”ç”¨.envé…ç½®
DB_SSL=true
```

---

## ğŸ“ è·å–å¸®åŠ©

### æ–‡æ¡£

- **å®Œæ•´æ–‡æ¡£**: [README.md](README.md)
- **å¿«é€Ÿä¸Šæ‰‹**: [QUICKSTART.md](QUICKSTART.md)
- **æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](CHANGELOG.md)

### å‘½ä»¤é€ŸæŸ¥

```bash
# æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
docker exec postgres_master psql -U admin -d postgres -c "SELECT get_system_stats();"

# æŸ¥çœ‹æ´»è·ƒç«™ç‚¹
docker exec postgres_master psql -U admin -d postgres -c "SELECT * FROM get_active_sites();"

# æŸ¥çœ‹æ—¥å¿—
docker logs postgres_master -f

# è¿›å…¥æ•°æ®åº“
docker exec -it postgres_master psql -U admin -d postgres

# åœæ­¢ç³»ç»Ÿ
docker compose -f docker-compose.vps.yml down

# é‡å¯ç³»ç»Ÿ
docker compose -f docker-compose.vps.yml restart
```

---

## ğŸ¯ æ€»ç»“

### å…³é”®æ­¥éª¤å›é¡¾

1. **æœ¬åœ°éªŒè¯** â†’ ç¡®ä¿ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
2. **æ‰“åŒ…ä¸Šä¼ ** â†’ å°†ç³»ç»Ÿéƒ¨ç½²åˆ°VPS
3. **ä¿®æ”¹å¯†ç ** â†’ ä½¿ç”¨ç”Ÿäº§å¯†ç 
4. **åº”ç”¨æ¥å…¥** â†’ é…ç½®åº”ç”¨è¿æ¥PostgreSQL
5. **éªŒè¯æµ‹è¯•** â†’ ç¡®è®¤æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
6. **ç›‘æ§å¤‡ä»½** â†’ è®¾ç½®ç›‘æ§å’Œè‡ªåŠ¨å¤‡ä»½

### é‡è¦æé†’

- âš ï¸ **VPSéƒ¨ç½²å‰å¿…é¡»ä¿®æ”¹æ‰€æœ‰å¯†ç **
- âš ï¸ **ç¡®ä¿åº”ç”¨å®¹å™¨è¿æ¥åˆ°shared_netç½‘ç»œ**
- âš ï¸ **è¡¨åå¿…é¡»ä¸PostgreSQLä¸­çš„è¡¨åä¸€è‡´**
- âš ï¸ **å®šæœŸå¤‡ä»½æ•°æ®åº“**
- âš ï¸ **ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€**

---

**ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå®Œæ•´æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚** ğŸš€

