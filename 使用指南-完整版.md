# PostgreSQL总系统 - 完整使用指南

## 📦 系统概述

这是一个**完全独立**的PostgreSQL总系统文件夹，可以**单独拷贝**到任何地方使用，支持：

- ✅ **本地测试**：在本地Windows/Mac/Linux上完整验证
- ✅ **VPS部署**：一键部署到生产环境
- ✅ **多站点支持**：支持20个站点共享同一个PostgreSQL实例
- ✅ **完整隔离**：与现有程序完全独立，不影响现有代码

---

## 📁 文件夹结构

```
postgres-master-system/               # 独立的PostgreSQL系统文件夹
│
├── README.md                         # 📖 完整文档（推荐先阅读）
├── QUICKSTART.md                     # 🚀 5分钟快速上手
├── CHANGELOG.md                      # 📝 更新日志
├── 使用指南-完整版.md                 # 📘 本文件
│
├── docker-compose.local.yml          # 🏠 本地测试配置
├── docker-compose.vps.yml            # 🚀 VPS生产配置
├── .gitignore                        # 忽略文件配置
│
├── init-scripts/                     # 📂 数据库初始化脚本（自动执行）
│   ├── 01_unified_feedback.sql       # 统一反馈表
│   ├── 02_site4_colormagic.sql       # Site4 (ColorMagic) 专用表
│   └── 03_sites_and_functions.sql    # 其他站点用户和系统函数
│
├── scripts/                          # 📂 管理脚本
│   ├── local-start.bat               # Windows本地启动
│   ├── local-start.sh                # Linux/Mac本地启动
│   ├── local-verify.bat              # Windows本地验证
│   ├── local-verify.sh               # Linux/Mac本地验证
│   └── export-to-vps.sh              # 导出到VPS脚本
│
└── backups/                          # 📂 备份文件目录
    └── .gitkeep

总计：16个文件，3个文件夹
```

---

## 🎯 三种使用场景

### 场景1：本地测试验证（推荐先做）

**目的**：在本地完整验证PostgreSQL系统，确保所有表和权限配置正确

**Windows操作步骤**：

```cmd
# 1. 复制文件夹到本地测试目录
xcopy /E /I postgres-master-system C:\test-postgres

# 2. 进入测试目录
cd C:\test-postgres

# 3. 启动PostgreSQL
scripts\local-start.bat

# 4. 等待15秒后验证
scripts\local-verify.bat
```

**Linux/Mac操作步骤**：

```bash
# 1. 复制文件夹到本地测试目录
cp -r postgres-master-system ~/test-postgres

# 2. 进入测试目录
cd ~/test-postgres

# 3. 赋予执行权限
chmod +x scripts/*.sh

# 4. 启动PostgreSQL
./scripts/local-start.sh

# 5. 等待15秒后验证
./scripts/local-verify.sh
```

**验证成功标志**：

```
✅ 所有验证测试完成 - 系统正常运行
   成功: 8/8
   失败: 0/8

📝 系统统计:
{
  "systemName": "PostgreSQL总系统",
  "version": "2.0",
  "totalSites": 1,
  "totalFeedbacks": 3,
  "colormagic": {
    "users": 1,
    "analyses": 0,
    "palettes": 1,
    "exports": 0
  }
}
```

---

### 场景2：打包上传到VPS

**目的**：将本地验证成功的系统部署到VPS生产环境

**步骤1：本地打包**

```bash
# 进入系统目录
cd postgres-master-system

# 运行导出脚本（Linux/Mac）
./scripts/export-to-vps.sh

# Windows用户手动打包
# 压缩整个 postgres-master-system 文件夹为 .tar.gz 或 .zip
```

**步骤2：上传到VPS**

```bash
# 上传到VPS
scp export-to-vps/postgres-master-system.tar.gz root@YOUR_VPS_IP:/tmp/

# 或使用其他工具（FTP、SFTP、宝塔等）上传
```

**步骤3：VPS上部署**

```bash
# SSH到VPS
ssh root@YOUR_VPS_IP

# 创建部署目录
mkdir -p /docker/db_master
cd /docker/db_master

# 解压
tar -xzf /tmp/postgres-master-system.tar.gz

# ⚠️ 重要：修改生产密码
nano init-scripts/02_site4_colormagic.sql
# 将 ColorMagic_Local_Test_Pass 改为 ColorMagic_VPS_2024_Secure_Pass

nano init-scripts/03_sites_and_functions.sql
# 将 site%s_test_pass 改为 site%s_pass

# 创建Docker网络
docker network create shared_net 2>/dev/null || true

# 启动PostgreSQL
docker compose -f docker-compose.vps.yml up -d

# 等待初始化
sleep 20

# 查看日志
docker logs postgres_master --tail 50

# 验证部署
docker exec postgres_master psql -U admin -d postgres -c "SELECT get_system_stats();"
```

---

### 场景3：应用接入PostgreSQL系统

**目的**：让Site4 (ColorMagic) 应用连接到PostgreSQL总系统

#### 3.1 应用环境变量配置

编辑应用的 `.env` 文件：

```bash
# /docker/site4/backend/.env

# ============================================
# PostgreSQL总系统连接配置
# ============================================
USE_DATABASE=true
DB_HOST=postgres_master          # Docker网络别名（不是容器ID）
DB_PORT=5432
DB_NAME=postgres
DB_USER=colormagic_user
DB_PASSWORD=ColorMagic_VPS_2024_Secure_Pass
DB_SSL=false
DB_MAX_CONNECTIONS=20

# 站点标识（用于unified_feedback表）
SITE_ID=colormagic

# ============================================
# 其他配置
# ============================================
NODE_ENV=production
PORT=3000
JWT_SECRET=your-super-secret-jwt-key
ALLOWED_ORIGINS=https://imagecolorpicker.cc,https://www.imagecolorpicker.cc
```

#### 3.2 应用Docker配置

确保应用容器连接到 `shared_net` 网络：

```bash
# 方式1：docker run（手动启动）
docker run -d --name site4 \
  --network shared_net \
  --env-file backend/.env \
  your-image:latest

# 方式2：docker-compose.yml（推荐）
# 在应用的docker-compose.yml中添加：
services:
  site4:
    image: your-image
    networks:
      - shared_net
    environment:
      - USE_DATABASE=true
      - DB_HOST=postgres_master
    # ... 其他配置

networks:
  shared_net:
    external: true
```

#### 3.3 代码适配

**重要：表名需要与PostgreSQL系统中的表名一致**

| 代码中可能的表名 | PostgreSQL实际表名 | 说明 |
|-----------------|-------------------|------|
| `users` | `colormagic_users` | 用户表 |
| `user_sessions` | `colormagic_sessions` | 会话表 |
| `user_analysis_history` | `colormagic_analysis_history` | 用户分析历史 |
| `user_favorite_palettes` | `colormagic_palettes` | 收藏调色板 |
| `user_usage_stats` | `colormagic_usage_stats` | 使用统计 |
| `analysis_history` | `colormagic_color_analysis` | 颜色分析记录 |
| `export_history` | `colormagic_export_history` | 导出历史 |
| `unified_feedback` | `unified_feedback` | 反馈表（使用site_id='colormagic'） |

**检查代码中的SQL语句**：

```typescript
// ❌ 错误：使用旧表名
const query = 'SELECT * FROM users WHERE id = $1';

// ✅ 正确：使用新表名
const query = 'SELECT * FROM colormagic_users WHERE id = $1';
```

**或者使用环境变量配置表前缀**：

```typescript
// config/database.ts
const TABLE_PREFIX = process.env.TABLE_PREFIX || 'colormagic_';

const getUserQuery = `SELECT * FROM ${TABLE_PREFIX}users WHERE id = $1`;
```

#### 3.4 验证应用连接

```bash
# 1. 检查应用容器网络
docker inspect site4 | grep -A 10 "Networks"

# 2. 测试DNS解析
docker exec site4 ping -c 2 postgres_master

# 3. 测试端口连接
docker exec site4 nc -zv postgres_master 5432

# 4. 查看应用日志（确认数据库连接）
docker logs site4 | grep -i database

# 5. 测试应用API
curl http://localhost:3000/health
curl http://localhost:3000/api/feedback/health
```

---

## 🔍 验证检查清单

### PostgreSQL系统检查

```bash
# ✅ 1. 容器运行
docker ps | grep postgres_master
# 预期：看到postgres_master容器在运行

# ✅ 2. 数据库版本
docker exec postgres_master psql -U admin -d postgres -c "SELECT version();"
# 预期：PostgreSQL 15.x

# ✅ 3. 系统统计
docker exec postgres_master psql -U admin -d postgres -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"
# 预期：返回完整的JSON统计数据

# ✅ 4. 表列表
docker exec postgres_master psql -U admin -d postgres -c "\dt"
# 预期：看到8-10个表（unified_feedback + colormagic_*）

# ✅ 5. ColorMagic表
docker exec postgres_master psql -U admin -d postgres -c "\dt colormagic_*"
# 预期：看到7个colormagic_开头的表

# ✅ 6. 用户列表
docker exec postgres_master psql -U admin -d postgres -c "\du"
# 预期：看到admin + colormagic_user + site1_user ~ site20_user

# ✅ 7. ColorMagic用户连接
docker exec postgres_master psql -U colormagic_user -d postgres -c "SELECT current_user;"
# 预期：返回 colormagic_user

# ✅ 8. ColorMagic用户权限
docker exec postgres_master psql -U colormagic_user -d postgres -c "SELECT COUNT(*) FROM colormagic_users;"
# 预期：返回数字（至少1）

# ✅ 9. 插入测试反馈
docker exec postgres_master psql -U colormagic_user -d postgres -c "
INSERT INTO unified_feedback (site_id, content, category) 
VALUES ('colormagic', '系统验证测试', 'test') 
RETURNING id, site_id, content;
"
# 预期：返回插入的记录

# ✅ 10. 查询反馈
docker exec postgres_master psql -U colormagic_user -d postgres -c "
SELECT id, site_id, LEFT(content, 30) as content, created_at 
FROM unified_feedback 
WHERE site_id = 'colormagic' 
ORDER BY created_at DESC 
LIMIT 3;
"
# 预期：看到最近的3条反馈记录
```

### 应用接入检查

```bash
# ✅ 1. 应用容器运行
docker ps | grep site4

# ✅ 2. 应用网络连接
docker network inspect shared_net | grep -A 3 site4
docker network inspect shared_net | grep -A 3 postgres

# ✅ 3. DNS解析
docker exec site4 ping -c 2 postgres_master
# 预期：能够解析并ping通

# ✅ 4. 端口连接
docker exec site4 nc -zv postgres_master 5432
# 预期：Connection succeeded

# ✅ 5. 环境变量
docker exec site4 env | grep -E '(DB_HOST|DB_USER|DB_PASSWORD)'
# 预期：看到正确的数据库配置

# ✅ 6. 应用日志
docker logs site4 --tail 50 | grep -i database
# 预期：看到数据库连接成功的日志

# ✅ 7. 健康检查
curl http://localhost:3000/health
# 预期：{"status":"ok"}

# ✅ 8. 反馈API健康检查
curl http://localhost:3000/api/feedback/health
# 预期：{"success":true,"service":"Feedback Service"}
```

---

## 🆘 常见问题解决

### 问题1：本地端口5432冲突

**症状**：启动失败，提示端口被占用

**解决**：
```bash
# 本地测试已自动使用5433端口
# 如果仍有冲突，修改 docker-compose.local.yml:
ports:
  - "5434:5432"  # 改为5434或其他端口
```

### 问题2：应用无法连接postgres_master

**症状**：`getaddrinfo ENOTFOUND postgres_master`

**检查**：
```bash
# 1. 确认shared_net网络存在
docker network ls | grep shared_net

# 2. 确认postgres容器在shared_net中
docker network inspect shared_net | grep postgres

# 3. 确认应用容器在shared_net中
docker network inspect shared_net | grep site4
```

**解决**：
```bash
# 重新连接网络
docker network disconnect shared_net site4 2>/dev/null || true
docker network connect shared_net site4
```

### 问题3：密码认证失败

**症状**：`password authentication failed for user "colormagic_user"`

**检查**：
```bash
# 1. 查看应用.env中的密码
cat /docker/site4/backend/.env | grep DB_PASSWORD

# 2. 测试密码是否正确
PGPASSWORD='YourPassword' docker exec postgres_master psql -U colormagic_user -d postgres -c "SELECT current_user;"
```

**解决**：
```bash
# 方式1：重置PostgreSQL中的密码
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER colormagic_user WITH PASSWORD 'NewPassword123';
"

# 方式2：更新应用.env文件
nano /docker/site4/backend/.env
# 修改 DB_PASSWORD=NewPassword123

# 重启应用容器（重要！）
docker stop site4 && docker rm site4
docker compose up -d
```

### 问题4：表不存在

**症状**：`relation "colormagic_users" does not exist`

**原因**：
- 初始化脚本未执行（Docker卷已存在数据）
- 表名不匹配

**解决**：
```bash
# 方式1：完全重新初始化
docker compose down -v  # -v 会删除数据卷
docker compose -f docker-compose.vps.yml up -d

# 方式2：手动执行初始化脚本
cat init-scripts/02_site4_colormagic.sql | \
  docker exec -i postgres_master psql -U admin -d postgres

# 方式3：检查表是否以其他名字存在
docker exec postgres_master psql -U admin -d postgres -c "\dt"
```

### 问题5：应用启动后数据库连接池耗尽

**症状**：`remaining connection slots are reserved`

**检查**：
```bash
# 查看当前连接数
docker exec postgres_master psql -U admin -d postgres -c "
SELECT count(*) as connections, usename 
FROM pg_stat_activity 
GROUP BY usename;
"
```

**解决**：
```bash
# 1. 增加max_connections（在docker-compose.vps.yml中已设置为200）

# 2. 减少应用的连接池大小（在应用.env中）
DB_MAX_CONNECTIONS=10  # 改小一些

# 3. 清理空闲连接
docker exec postgres_master psql -U admin -d postgres -c "
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'idle' AND state_change < now() - interval '5 minutes';
"
```

---

## 📊 系统监控

### 实时监控命令

```bash
# 1. 实时查看系统统计（每5秒刷新）
watch -n 5 'docker exec postgres_master psql -U admin -d postgres -t -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"'

# 2. 查看实时日志
docker logs postgres_master -f

# 3. 查看活跃连接
docker exec postgres_master psql -U admin -d postgres -c "
SELECT usename, application_name, client_addr, state, query_start, query 
FROM pg_stat_activity 
WHERE state = 'active' 
ORDER BY query_start;
"

# 4. 查看表大小
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_total_relation_size(schemaname||'.'||tablename) AS size_bytes
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY size_bytes DESC;
"

# 5. 查看数据库大小
docker exec postgres_master psql -U admin -d postgres -c "
SELECT pg_database.datname, pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;
"
```

### 创建监控脚本

```bash
# 创建简单的监控脚本
cat > /docker/db_master/monitor.sh << 'EOF'
#!/bin/bash
echo "=========================================="
echo "PostgreSQL总系统 - 系统监控"
echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="
echo ""

echo "📊 系统统计:"
docker exec postgres_master psql -U admin -d postgres -t -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"

echo ""
echo "🔗 活跃连接数:"
docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT usename, COUNT(*) as connections 
FROM pg_stat_activity 
GROUP BY usename 
ORDER BY connections DESC;
"

echo ""
echo "💾 数据库大小:"
docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT pg_size_pretty(pg_database_size('postgres'));
"

echo ""
echo "=========================================="
EOF

chmod +x /docker/db_master/monitor.sh

# 使用监控脚本
/docker/db_master/monitor.sh
```

---

## 💾 备份和恢复

### 自动备份

```bash
# 创建自动备份脚本
cat > /docker/db_master/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/docker/db_master/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 全库备份
docker exec postgres_master pg_dumpall -U admin | \
  gzip > $BACKUP_DIR/postgres_full_${DATE}.sql.gz

# 只保留最近7天的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "✅ 备份完成: $BACKUP_DIR/postgres_full_${DATE}.sql.gz"
ls -lh $BACKUP_DIR | tail -5
EOF

chmod +x /docker/db_master/backup.sh

# 添加到crontab（每天凌晨3点备份）
crontab -e
# 添加这一行：
# 0 3 * * * /docker/db_master/backup.sh >> /docker/db_master/backup.log 2>&1
```

### 手动备份

```bash
# 1. 全库备份
docker exec postgres_master pg_dumpall -U admin | \
  gzip > backup_$(date +%Y%m%d).sql.gz

# 2. 只备份ColorMagic表
docker exec postgres_master pg_dump -U admin -d postgres \
  -t 'colormagic_*' -t 'unified_feedback' | \
  gzip > colormagic_backup_$(date +%Y%m%d).sql.gz

# 3. 只备份结构（不含数据）
docker exec postgres_master pg_dumpall -U admin --schema-only > \
  schema_$(date +%Y%m%d).sql
```

### 恢复数据

```bash
# 1. 恢复完整备份
gunzip -c backup_20241002.sql.gz | \
  docker exec -i postgres_master psql -U admin -d postgres

# 2. 恢复单个表
cat colormagic_backup_20241002.sql | \
  docker exec -i postgres_master psql -U admin -d postgres

# 3. 恢复前先停止应用
docker stop site4
# 恢复...
docker start site4
```

---

## 🔐 安全建议

### 1. 修改默认密码

```bash
# 修改admin密码
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER admin WITH PASSWORD 'YourStrongPassword123!@#';
"

# 修改colormagic_user密码
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER colormagic_user WITH PASSWORD 'YourStrongPassword456!@#';
"

# 同时更新应用的.env文件
nano /docker/site4/backend/.env
```

### 2. 限制远程访问

```yaml
# 编辑 docker-compose.vps.yml
# 方式1：完全禁用外部访问（推荐）
# ports:
#   - "5432:5432"  # 注释掉

# 方式2：只允许本地访问
ports:
  - "127.0.0.1:5432:5432"
```

### 3. 使用SSL连接

```yaml
# docker-compose.vps.yml 添加SSL配置
environment:
  - POSTGRES_SSL=on
volumes:
  - ./ssl/server.crt:/var/lib/postgresql/server.crt
  - ./ssl/server.key:/var/lib/postgresql/server.key

# 应用.env配置
DB_SSL=true
```

---

## 📞 获取帮助

### 文档

- **完整文档**: [README.md](README.md)
- **快速上手**: [QUICKSTART.md](QUICKSTART.md)
- **更新日志**: [CHANGELOG.md](CHANGELOG.md)

### 命令速查

```bash
# 查看系统统计
docker exec postgres_master psql -U admin -d postgres -c "SELECT get_system_stats();"

# 查看活跃站点
docker exec postgres_master psql -U admin -d postgres -c "SELECT * FROM get_active_sites();"

# 查看日志
docker logs postgres_master -f

# 进入数据库
docker exec -it postgres_master psql -U admin -d postgres

# 停止系统
docker compose -f docker-compose.vps.yml down

# 重启系统
docker compose -f docker-compose.vps.yml restart
```

---

## 🎯 总结

### 关键步骤回顾

1. **本地验证** → 确保系统正常工作
2. **打包上传** → 将系统部署到VPS
3. **修改密码** → 使用生产密码
4. **应用接入** → 配置应用连接PostgreSQL
5. **验证测试** → 确认所有功能正常
6. **监控备份** → 设置监控和自动备份

### 重要提醒

- ⚠️ **VPS部署前必须修改所有密码**
- ⚠️ **确保应用容器连接到shared_net网络**
- ⚠️ **表名必须与PostgreSQL中的表名一致**
- ⚠️ **定期备份数据库**
- ⚠️ **监控系统运行状态**

---

**祝您部署顺利！如有问题，请参考完整文档或联系技术支持。** 🚀

