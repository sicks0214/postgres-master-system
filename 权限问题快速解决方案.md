# PostgreSQL æƒé™é—®é¢˜å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

> **åŸºäºå®æˆ˜ç»éªŒçš„å¿«é€Ÿå‚è€ƒæŒ‡å—**  
> **æœ€åæ›´æ–°**: 2024-10-02

---

## ğŸš¨ é—®é¢˜ç—‡çŠ¶

```bash
ERROR: permission denied for table site3__users
æˆ–
Error: permission denied for table colormagic_users
```

---

## âœ… å¿«é€Ÿè§£å†³ï¼ˆ3æ­¥ï¼‰

### æ­¥éª¤ 1: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰â­

```bash
# åœ¨ VPS ä¸Šæ‰§è¡Œ
cd /docker/db_master
chmod +x scripts/fix-permissions.sh

# è¿è¡Œè„šæœ¬ï¼ˆæ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·åï¼‰
./scripts/fix-permissions.sh site3_user
```

### æ­¥éª¤ 2: æ‰‹åŠ¨ä¿®å¤ï¼ˆå¤‡é€‰ï¼‰

```bash
# æ–¹æ³• A: æœ€ç®€å•ï¼ˆæ¨èï¼‰
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"

# æ–¹æ³• B: é’ˆå¯¹ç‰¹å®šç”¨æˆ·
SITE_USER="site3_user"
docker exec postgres_master psql -U admin -d postgres -c "
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"
```

### æ­¥éª¤ 3: éªŒè¯ä¿®å¤

```bash
# æµ‹è¯•è®¿é—®
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"

# åº”è¯¥è¿”å›ï¼š
# count 
# -------
#      0
# (1 row)
```

---

## ğŸ” è¯¦ç»†è¯Šæ–­æµç¨‹

å¦‚æœå¿«é€Ÿè§£å†³æ— æ•ˆï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤è¯Šæ–­ï¼š

### 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨

```bash
docker exec postgres_master psql -U admin -d postgres -c "\du site3_user"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
      Role name       |  Attributes  
----------------------+--------------
 site3_user           |              
```

**å¦‚æœä¸å­˜åœ¨**ï¼Œéœ€è¦å…ˆåˆ›å»ºï¼š
```bash
docker exec postgres_master psql -U admin -d postgres -c "
CREATE USER site3_user WITH PASSWORD 'site3_prod_pass_2024';
"
```

---

### 2. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨

```bash
docker exec postgres_master psql -U admin -d postgres -c "\dt site3__*"
```

**å¦‚æœè¡¨ä¸å­˜åœ¨**ï¼Œéœ€è¦å…ˆåˆ›å»ºè¡¨ï¼ˆè¿è¡Œåº”ç”¨çš„åˆå§‹åŒ–è„šæœ¬ï¼‰ã€‚

---

### 3. æ£€æŸ¥å½“å‰æƒé™

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT grantee, table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' AND table_name LIKE 'site3__%'
ORDER BY table_name;
"
```

**å¦‚æœè¿”å› 0 è¡Œ**ï¼Œè¯´æ˜æ²¡æœ‰æƒé™ï¼Œéœ€è¦æˆæƒã€‚

---

### 4. æ£€æŸ¥è¡¨çš„æ‰€æœ‰è€…

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT schemaname, tablename, tableowner 
FROM pg_tables 
WHERE tablename LIKE 'site3__%';
"
```

**æ‰€æœ‰è€…åº”è¯¥æ˜¯ `admin`**ã€‚å¦‚æœä¸æ˜¯ï¼Œå¯èƒ½å¯¼è‡´æƒé™é—®é¢˜ã€‚

---

## ğŸ”§ å®Œæ•´é‡ç½®æ–¹æ¡ˆ

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ•ˆï¼Œå®Œå…¨é‡ç½®ç”¨æˆ·å’Œæƒé™ï¼š

```bash
# è®¾ç½®å˜é‡
SITE_USER="site3_user"
SITE_PASSWORD="site3_prod_pass_2024"

# å®Œå…¨é‡ç½®
docker exec postgres_master psql -U admin -d postgres -c "
-- æ’¤é”€æ—§æƒé™
REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM $SITE_USER;
REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public FROM $SITE_USER;

-- åˆ é™¤å¹¶é‡æ–°åˆ›å»ºç”¨æˆ·
DROP USER IF EXISTS $SITE_USER;
CREATE USER $SITE_USER WITH PASSWORD '$SITE_PASSWORD';

-- æˆäºˆåŸºç¡€æƒé™
GRANT CONNECT ON DATABASE postgres TO $SITE_USER;
GRANT USAGE ON SCHEMA public TO $SITE_USER;

-- æˆäºˆè¡¨å’Œåºåˆ—æƒé™
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"

# æµ‹è¯•
docker exec postgres_master psql -U $SITE_USER -d postgres -c "SELECT current_user, COUNT(*) FROM site3__users;"
```

---

## ğŸ“‹ éªŒè¯æ£€æŸ¥æ¸…å•

æ‰§è¡Œä»¥ä¸‹æ‰€æœ‰æµ‹è¯•ï¼Œç¡®è®¤æƒé™å®Œå…¨æ­£å¸¸ï¼š

```bash
# âœ… 1. ç”¨æˆ·å¯ä»¥è¿æ¥
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT current_user;"

# âœ… 2. ç”¨æˆ·å¯ä»¥è¯»å–è¡¨
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"

# âœ… 3. ç”¨æˆ·å¯ä»¥æ’å…¥æ•°æ®
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO site3__users (username, email, password_hash) 
VALUES ('testuser', 'test@site3.com', 'test123') 
ON CONFLICT (email) DO NOTHING;
"

# âœ… 4. ç”¨æˆ·å¯ä»¥æ›´æ–°æ•°æ®
docker exec postgres_master psql -U site3_user -d postgres -c "
UPDATE site3__users SET password_hash = 'new_hash' WHERE username = 'testuser';
"

# âœ… 5. ç”¨æˆ·å¯ä»¥è®¿é—® unified_feedback
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO unified_feedback (site_id, content, category) 
VALUES ('site3', 'æµ‹è¯•åé¦ˆ', 'test') 
RETURNING id, site_id, content;
"

# âœ… 6. æŸ¥çœ‹æ‰€æœ‰æƒé™
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' 
ORDER BY table_name;
"
```

**å¦‚æœä»¥ä¸Š 6 ä¸ªæµ‹è¯•éƒ½é€šè¿‡ï¼Œæƒé™é…ç½®å®Œå…¨æ­£å¸¸ï¼** âœ…

---

## âŒ å¸¸è§é”™è¯¯å’ŒåŸå› 

### é”™è¯¯ 1: DO ä»£ç å—ä¸æ‰§è¡Œ

**ç—‡çŠ¶**ï¼šè¿è¡Œ DO ä»£ç å—åæ²¡æœ‰ä»»ä½•è¾“å‡º

**åŸå› **ï¼šæŸäº› shell ç¯å¢ƒä¸­ï¼Œheredoc æ–¹å¼çš„ DO ä»£ç å—å¯èƒ½é™é»˜å¤±è´¥

**è§£å†³**ï¼šä½¿ç”¨ `-c` å‚æ•°ç›´æ¥æ‰§è¡Œç®€å•çš„ GRANT å‘½ä»¤

```bash
# âŒ å¯èƒ½å¤±è´¥
docker exec postgres_master psql -U admin -d postgres << 'EOF'
DO $$
BEGIN
    GRANT ALL PRIVILEGES ON site3__users TO site3_user;
END $$;
EOF

# âœ… æ¨èæ–¹å¼
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
```

---

### é”™è¯¯ 2: GRANT å‘½ä»¤æ²¡æœ‰è¾“å‡º

**ç—‡çŠ¶**ï¼šæ‰§è¡Œ GRANT åæ²¡æœ‰çœ‹åˆ° "GRANT" å­—æ ·

**åŸå› **ï¼šå‘½ä»¤å¯èƒ½æ²¡æœ‰çœŸæ­£æ‰§è¡Œ

**è§£å†³**ï¼šç¡®ä¿ä½¿ç”¨ `-c` å‚æ•°ï¼Œå¹¶æ£€æŸ¥è¿”å›ç 

```bash
# æ­£ç¡®çš„æ‰§è¡Œæ–¹å¼
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"

# åº”è¯¥çœ‹åˆ°è¾“å‡ºï¼š
# GRANT
```

---

### é”™è¯¯ 3: æƒé™æŸ¥è¯¢è¿”å› 0 è¡Œ

**ç—‡çŠ¶**ï¼š
```sql
SELECT grantee, table_name FROM information_schema.table_privileges WHERE grantee = 'site3_user';
-- è¿”å› 0 rows
```

**åŸå› **ï¼šæƒé™ç¡®å®æ²¡æœ‰æˆäºˆæˆåŠŸ

**è§£å†³**ï¼šé‡æ–°æ‰§è¡Œæˆæƒå‘½ä»¤ï¼Œå¹¶ç¡®ä¿çœ‹åˆ° "GRANT" è¾“å‡º

---

## ğŸ¯ ä¸åŒç«™ç‚¹çš„åº”ç”¨ç¤ºä¾‹

### Site3
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"
```

### ColorMagic (Site4)
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO colormagic_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO colormagic_user;"
```

### Site1
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site1_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site1_user;"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®Œæ•´æ¥å…¥æŒ‡å—**: `åº”ç”¨æ¥å…¥PostgreSQLæ€»ç³»ç»ŸæŒ‡å—.md`
- **VPS éƒ¨ç½²æŒ‡å—**: `README.md`
- **é—®é¢˜æ’æŸ¥**: `ISSUES_AND_FIXES.md`

---

## ğŸ’¡ é¢„é˜²æªæ–½

### åœ¨åˆ›å»ºæ–°ç«™ç‚¹è¡¨æ—¶ï¼Œç«‹å³æˆæƒ

```bash
# åˆ›å»ºè¡¨åç«‹å³æˆæƒ
SITE_USER="site5_user"

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬åˆ›å»ºè¡¨
cat init-site5.sql | docker exec -i postgres_master psql -U admin -d postgres

# ç«‹å³æˆæƒ
docker exec postgres_master psql -U admin -d postgres -c "
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"
```

### åœ¨ PostgreSQL æ€»ç³»ç»Ÿä¸­é¢„æˆæƒ

ä¿®æ”¹ `init-scripts/03_sites_and_functions.sql`ï¼Œåœ¨åˆ›å»ºç”¨æˆ·åç«‹å³æˆæƒï¼š

```sql
-- åˆ›å»ºç”¨æˆ·åç«‹å³æˆæƒ
CREATE USER site5_user WITH PASSWORD 'site5_prod_pass_2024';
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site5_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site5_user;
```

---

## ğŸ†˜ ä»ç„¶æ— æ³•è§£å†³ï¼Ÿ

1. **æŸ¥çœ‹ PostgreSQL æ—¥å¿—**
   ```bash
   docker logs postgres_master --tail 100
   ```

2. **æ£€æŸ¥ PostgreSQL é…ç½®**
   ```bash
   docker exec postgres_master psql -U admin -d postgres -c "SHOW all;"
   ```

3. **è”ç³»æ”¯æŒ**
   - æä¾›å®Œæ•´çš„é”™è¯¯æ—¥å¿—
   - æä¾›æƒé™æŸ¥è¯¢ç»“æœ
   - æä¾›è¡¨ç»“æ„ä¿¡æ¯

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-10-02  
**åŸºäº**: PostgreSQL æ€»ç³»ç»Ÿ v2.0  
**éªŒè¯çŠ¶æ€**: âœ… å·²åœ¨ Site3 å®æˆ˜éªŒè¯æˆåŠŸ

