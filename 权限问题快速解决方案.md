# PostgreSQL 权限问题快速解决方案

> **基于实战经验的快速参考指南**  
> **最后更新**: 2024-10-02

---

## 🚨 问题症状

```bash
ERROR: permission denied for table site3__users
或
Error: permission denied for table colormagic_users
```

---

## ✅ 快速解决（3步）

### 步骤 1: 使用自动化脚本（推荐）⭐

```bash
# 在 VPS 上执行
cd /docker/db_master
chmod +x scripts/fix-permissions.sh

# 运行脚本（替换为你的用户名）
./scripts/fix-permissions.sh site3_user
```

### 步骤 2: 手动修复（备选）

```bash
# 方法 A: 最简单（推荐）
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"

# 方法 B: 针对特定用户
SITE_USER="site3_user"
docker exec postgres_master psql -U admin -d postgres -c "
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"
```

### 步骤 3: 验证修复

```bash
# 测试访问
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"

# 应该返回：
# count 
# -------
#      0
# (1 row)
```

---

## 🔍 详细诊断流程

如果快速解决无效，按以下步骤诊断：

### 1. 检查用户是否存在

```bash
docker exec postgres_master psql -U admin -d postgres -c "\du site3_user"
```

**预期输出**：
```
      Role name       |  Attributes  
----------------------+--------------
 site3_user           |              
```

**如果不存在**，需要先创建：
```bash
docker exec postgres_master psql -U admin -d postgres -c "
CREATE USER site3_user WITH PASSWORD 'site3_prod_pass_2024';
"
```

---

### 2. 检查表是否存在

```bash
docker exec postgres_master psql -U admin -d postgres -c "\dt site3__*"
```

**如果表不存在**，需要先创建表（运行应用的初始化脚本）。

---

### 3. 检查当前权限

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT grantee, table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' AND table_name LIKE 'site3__%'
ORDER BY table_name;
"
```

**如果返回 0 行**，说明没有权限，需要授权。

---

### 4. 检查表的所有者

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT schemaname, tablename, tableowner 
FROM pg_tables 
WHERE tablename LIKE 'site3__%';
"
```

**所有者应该是 `admin`**。如果不是，可能导致权限问题。

---

## 🔧 完整重置方案

如果以上方法都无效，完全重置用户和权限：

```bash
# 设置变量
SITE_USER="site3_user"
SITE_PASSWORD="site3_prod_pass_2024"

# 完全重置
docker exec postgres_master psql -U admin -d postgres -c "
-- 撤销旧权限
REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM $SITE_USER;
REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public FROM $SITE_USER;

-- 删除并重新创建用户
DROP USER IF EXISTS $SITE_USER;
CREATE USER $SITE_USER WITH PASSWORD '$SITE_PASSWORD';

-- 授予基础权限
GRANT CONNECT ON DATABASE postgres TO $SITE_USER;
GRANT USAGE ON SCHEMA public TO $SITE_USER;

-- 授予表和序列权限
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"

# 测试
docker exec postgres_master psql -U $SITE_USER -d postgres -c "SELECT current_user, COUNT(*) FROM site3__users;"
```

---

## 📋 验证检查清单

执行以下所有测试，确认权限完全正常：

```bash
# ✅ 1. 用户可以连接
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT current_user;"

# ✅ 2. 用户可以读取表
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"

# ✅ 3. 用户可以插入数据
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO site3__users (username, email, password_hash) 
VALUES ('testuser', 'test@site3.com', 'test123') 
ON CONFLICT (email) DO NOTHING;
"

# ✅ 4. 用户可以更新数据
docker exec postgres_master psql -U site3_user -d postgres -c "
UPDATE site3__users SET password_hash = 'new_hash' WHERE username = 'testuser';
"

# ✅ 5. 用户可以访问 unified_feedback
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO unified_feedback (site_id, content, category) 
VALUES ('site3', '测试反馈', 'test') 
RETURNING id, site_id, content;
"

# ✅ 6. 查看所有权限
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' 
ORDER BY table_name;
"
```

**如果以上 6 个测试都通过，权限配置完全正常！** ✅

---

## ❌ 常见错误和原因

### 错误 1: DO 代码块不执行

**症状**：运行 DO 代码块后没有任何输出

**原因**：某些 shell 环境中，heredoc 方式的 DO 代码块可能静默失败

**解决**：使用 `-c` 参数直接执行简单的 GRANT 命令

```bash
# ❌ 可能失败
docker exec postgres_master psql -U admin -d postgres << 'EOF'
DO $$
BEGIN
    GRANT ALL PRIVILEGES ON site3__users TO site3_user;
END $$;
EOF

# ✅ 推荐方式
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
```

---

### 错误 2: GRANT 命令没有输出

**症状**：执行 GRANT 后没有看到 "GRANT" 字样

**原因**：命令可能没有真正执行

**解决**：确保使用 `-c` 参数，并检查返回码

```bash
# 正确的执行方式
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"

# 应该看到输出：
# GRANT
```

---

### 错误 3: 权限查询返回 0 行

**症状**：
```sql
SELECT grantee, table_name FROM information_schema.table_privileges WHERE grantee = 'site3_user';
-- 返回 0 rows
```

**原因**：权限确实没有授予成功

**解决**：重新执行授权命令，并确保看到 "GRANT" 输出

---

## 🎯 不同站点的应用示例

### Site3
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"
```

### ColorMagic (Site4)
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO colormagic_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO colormagic_user;"
```

### Site1
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site1_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site1_user;"
```

---

## 📚 相关文档

- **完整接入指南**: `应用接入PostgreSQL总系统指南.md`
- **VPS 部署指南**: `README.md`
- **问题排查**: `ISSUES_AND_FIXES.md`

---

## 💡 预防措施

### 在创建新站点表时，立即授权

```bash
# 创建表后立即授权
SITE_USER="site5_user"

# 执行初始化脚本创建表
cat init-site5.sql | docker exec -i postgres_master psql -U admin -d postgres

# 立即授权
docker exec postgres_master psql -U admin -d postgres -c "
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"
```

### 在 PostgreSQL 总系统中预授权

修改 `init-scripts/03_sites_and_functions.sql`，在创建用户后立即授权：

```sql
-- 创建用户后立即授权
CREATE USER site5_user WITH PASSWORD 'site5_prod_pass_2024';
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site5_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site5_user;
```

---

## 🆘 仍然无法解决？

1. **查看 PostgreSQL 日志**
   ```bash
   docker logs postgres_master --tail 100
   ```

2. **检查 PostgreSQL 配置**
   ```bash
   docker exec postgres_master psql -U admin -d postgres -c "SHOW all;"
   ```

3. **联系支持**
   - 提供完整的错误日志
   - 提供权限查询结果
   - 提供表结构信息

---

**版本**: v1.0  
**最后更新**: 2024-10-02  
**基于**: PostgreSQL 总系统 v2.0  
**验证状态**: ✅ 已在 Site3 实战验证成功

