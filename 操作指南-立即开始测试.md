# ColorMagic 数据库 - 立即开始测试 🚀

## ⏰ 当前状态

- ✅ Docker Desktop 正在启动中（通常需要1-2分钟）
- ✅ 已创建完整测试脚本
- ✅ 已准备详细的数据库结构文档
- ⏳ 等待 Docker 就绪后即可开始测试

---

## 📋 测试前准备（5分钟）

### 1. 等待 Docker Desktop 完全启动

**检查方法**：
- 查看系统托盘，Docker 图标显示为 **绿色** 表示已就绪
- 或者打开命令行，运行：
  ```cmd
  docker ps
  ```
  如果能看到列表（即使是空的），说明 Docker 已就绪

### 2. 已准备的文件

在当前目录下，我已经为你创建了：

| 文件名 | 说明 |
|--------|------|
| `本地测试指南.bat` | 一键运行完整测试（推荐） |
| `ColorMagic数据库结构详解.md` | 数据库详细结构文档 |
| `操作指南-立即开始测试.md` | 本文件 |

---

## 🚀 开始测试（3步完成）

### 方式1：一键自动测试（推荐）⭐

1. **等待 Docker 图标变绿**（系统托盘右下角）

2. **双击运行测试脚本**
   ```
   双击 → 本地测试指南.bat
   ```

3. **查看测试结果**
   - 脚本会自动：
     - ✅ 启动 PostgreSQL 容器
     - ✅ 验证所有表和用户
     - ✅ 测试数据查询和插入
     - ✅ 检查系统函数
     - ✅ 显示详细统计信息

4. **预期结果**
   ```
   ============================================
   📊 测试结果汇总
   ============================================
   
      成功: 13/13
      失败: 0/13
   
   ✅✅✅ 所有测试通过 - ColorMagic 数据库系统正常运行！
   ```

---

### 方式2：手动逐步测试

如果你想了解每一步的细节，可以手动执行：

#### 步骤1：启动 PostgreSQL
```cmd
docker compose -f docker-compose.local.yml up -d
```

等待 20 秒，让数据库初始化完成。

#### 步骤2：查看启动日志
```cmd
docker logs postgres_local_test --tail 30
```

应该看到：
```
✅ 创建用户: colormagic_user
✅ Site4 (ColorMagic) 表和权限配置完成
PostgreSQL总系统初始化完成
```

#### 步骤3：测试数据库连接
```cmd
docker exec postgres_local_test psql -U admin -d postgres -c "SELECT version();"
```

#### 步骤4：查看 ColorMagic 表列表
```cmd
docker exec postgres_local_test psql -U admin -d postgres -c "\dt colormagic_*"
```

应该看到 7 个表：
- colormagic_users
- colormagic_sessions
- colormagic_analysis_history
- colormagic_palettes
- colormagic_usage_stats
- colormagic_color_analysis
- colormagic_export_history

#### 步骤5：查看测试数据
```cmd
docker exec postgres_local_test psql -U admin -d postgres -c "SELECT username, email FROM colormagic_users;"
```

应该看到测试用户：
```
 username |        email         
----------+----------------------
 testuser | test@colormagic.com
```

#### 步骤6：测试系统统计
```cmd
docker exec postgres_local_test psql -U admin -d postgres -c "SELECT jsonb_pretty(get_system_stats()::jsonb);"
```

应该看到完整的 JSON 统计信息。

---

## 📊 ColorMagic 数据库结构概览

### 核心表（7个）

1. **colormagic_users** - 用户表
   - 支持：注册、登录、订阅管理
   - 字段：email, username, password_hash, subscription_type 等

2. **colormagic_sessions** - 会话表
   - 支持：JWT token 管理、刷新令牌
   - 字段：token_hash, refresh_token_hash, expires_at 等

3. **colormagic_analysis_history** - 用户分析历史
   - 记录登录用户的图片分析历史
   - 字段：analysis_result (JSONB), analysis_type, tags 等

4. **colormagic_palettes** - 收藏调色板
   - 用户保存的调色板
   - 字段：palette_name, colors (JSONB), tags 等

5. **colormagic_usage_stats** - 使用统计
   - 按日统计用户使用情况
   - 字段：date, analyses_count, ai_analyses_count

6. **colormagic_color_analysis** - 颜色分析记录
   - 记录所有的颜色分析（包括匿名）
   - 字段：analysis_id, extracted_colors (JSONB), palette (JSONB) 等

7. **colormagic_export_history** - 导出历史
   - 记录导出操作
   - 字段：export_format, color_count, file_size_bytes 等

### 系统函数（4个）

1. **get_system_stats()** - 获取总系统统计
2. **get_colormagic_system_stats()** - 获取 ColorMagic 统计
3. **get_active_sites()** - 获取活跃站点列表
4. **cleanup_expired_sessions()** - 清理过期会话

### 测试数据

系统已内置测试数据：
- **测试用户**: testuser / test@colormagic.com（密码：test123）
- **测试调色板**: "Sunset Colors"（Coral + Gold）
- **测试反馈**: 2条 ColorMagic 反馈记录

---

## 🔍 详细测试项目（13项）

自动测试脚本会执行以下检查：

| # | 测试项 | 说明 |
|---|--------|------|
| 1 | 数据库连接 | 验证可以连接到 PostgreSQL |
| 2 | 统一反馈表 | 检查共享反馈表是否存在 |
| 3 | ColorMagic 表数量 | 验证 7 个表是否全部创建 |
| 4 | colormagic_user 连接 | 测试专用用户是否可以连接 |
| 5 | colormagic_user 权限 | 验证用户权限是否正确 |
| 6 | 查询测试用户 | 读取测试用户数据 |
| 7 | 查询测试调色板 | 读取测试调色板数据 |
| 8 | 查询反馈记录 | 读取 ColorMagic 反馈 |
| 9 | 插入反馈测试 | 测试插入新反馈 |
| 10 | 插入分析记录 | 测试插入颜色分析记录 |
| 11 | get_system_stats() | 测试系统统计函数 |
| 12 | get_colormagic_system_stats() | 测试 ColorMagic 统计函数 |
| 13 | get_active_sites() | 测试活跃站点函数 |

---

## 📖 查看详细文档

测试完成后，可以查看详细文档：

```cmd
notepad ColorMagic数据库结构详解.md
```

或者在浏览器中打开（如果有 Markdown 查看器）。

---

## 🎯 测试完成后的下一步

### 如果所有测试通过 ✅

你的 ColorMagic 数据库系统已完全就绪！下一步：

1. **配置应用环境变量**
   ```env
   USE_DATABASE=true
   DB_HOST=postgres_master
   DB_PORT=5432
   DB_NAME=postgres
   DB_USER=colormagic_user
   DB_PASSWORD=ColorMagic_Local_Test_Pass
   SITE_ID=colormagic
   ```

2. **确保应用使用正确的表名**
   - `users` → `colormagic_users`
   - `sessions` → `colormagic_sessions`
   - `analysis_history` → `colormagic_color_analysis`
   - 等等...

3. **连接应用容器到 shared_net 网络**
   ```yaml
   networks:
     - shared_net
   ```

4. **启动应用并测试**

---

### 如果测试失败 ❌

**常见问题和解决方法**：

1. **容器启动失败**
   ```cmd
   # 查看详细日志
   docker logs postgres_local_test
   
   # 检查端口冲突
   # 如果本地已有 PostgreSQL 在 5432 端口
   # 系统会自动使用 5433 端口
   ```

2. **表不存在**
   ```cmd
   # 重新初始化（会删除所有数据）
   docker compose -f docker-compose.local.yml down -v
   docker compose -f docker-compose.local.yml up -d
   ```

3. **权限错误**
   ```cmd
   # 检查日志中的权限配置信息
   docker logs postgres_local_test | findstr "权限"
   ```

---

## 💡 有用的命令

### 日常操作
```cmd
# 查看容器状态
docker ps

# 查看实时日志
docker logs postgres_local_test -f

# 进入数据库（交互式）
docker exec -it postgres_local_test psql -U admin -d postgres

# 停止容器
docker compose -f docker-compose.local.yml down

# 重启容器
docker compose -f docker-compose.local.yml restart
```

### 数据库查询（在交互式 psql 中）
```sql
-- 列出所有表
\dt

-- 列出 ColorMagic 表
\dt colormagic_*

-- 列出所有用户
\du

-- 查看表结构
\d colormagic_users

-- 退出
\q
```

---

## 📞 需要帮助？

如果遇到问题：

1. **查看日志**
   ```cmd
   docker logs postgres_local_test --tail 100
   ```

2. **检查 Docker 状态**
   ```cmd
   docker info
   ```

3. **查看完整文档**
   - README.md
   - 使用指南-完整版.md
   - ColorMagic数据库结构详解.md

---

## ⏰ 现在就开始测试！

**立即执行**：

1. ✅ 确认 Docker Desktop 图标是绿色的
2. ✅ 双击运行 `本地测试指南.bat`
3. ✅ 等待 1-2 分钟看到测试结果
4. ✅ 查看 `ColorMagic数据库结构详解.md` 了解详情

---

**祝测试顺利！** 🎉

如果所有测试通过，你的 ColorMagic 数据库系统就可以投入使用了！

