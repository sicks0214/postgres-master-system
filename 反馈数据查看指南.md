# åé¦ˆæ•°æ®æŸ¥çœ‹æŒ‡å—

> **PostgreSQL æ€»ç³»ç»Ÿ - unified_feedback è¡¨ç®¡ç†**  
> **æœ€åæ›´æ–°**: 2024-10-02

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰â­

```bash
# åœ¨ VPS ä¸Šæ‰§è¡Œ
cd /docker/db_master
chmod +x scripts/view-feedbacks.sh

# æŸ¥çœ‹æ‰€æœ‰åé¦ˆ
./scripts/view-feedbacks.sh

# æŸ¥çœ‹ç‰¹å®šç«™ç‚¹
./scripts/view-feedbacks.sh site3
./scripts/view-feedbacks.sh colormagic

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
./scripts/view-feedbacks.sh stats

# æŸ¥çœ‹å¾…å¤„ç†çš„åé¦ˆ
./scripts/view-feedbacks.sh pending

# æŸ¥çœ‹æ›´å¤šåé¦ˆï¼ˆæŒ‡å®šæ•°é‡ï¼‰
./scripts/view-feedbacks.sh site3 50
```

---

## ğŸ“Š unified_feedback è¡¨ç»“æ„

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `id` | SERIAL | ä¸»é”®ï¼Œè‡ªå¢ | 1, 2, 3... |
| `site_id` | VARCHAR(50) | ç«™ç‚¹æ ‡è¯† | 'site3', 'colormagic' |
| `user_id` | UUID | ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰ | UUID æˆ– NULL |
| `content` | TEXT | åé¦ˆå†…å®¹ | 'ç½‘ç«™å¾ˆå¥½ç”¨' |
| `contact` | VARCHAR(255) | è”ç³»æ–¹å¼ | 'user@example.com' |
| `rating` | INTEGER | è¯„åˆ† 1-5 | 5 |
| `category` | VARCHAR(50) | åˆ†ç±» | 'general', 'bug', 'feature' |
| `user_ip` | VARCHAR(45) | ç”¨æˆ·IP | '192.168.1.1' |
| `user_agent` | TEXT | ç”¨æˆ·ä»£ç† | 'Mozilla/5.0...' |
| `status` | VARCHAR(20) | çŠ¶æ€ | 'pending', 'reviewed', 'resolved' |
| `admin_notes` | TEXT | ç®¡ç†å‘˜å¤‡æ³¨ | 'å·²å¤„ç†' |
| `created_at` | TIMESTAMP | åˆ›å»ºæ—¶é—´ | '2024-10-02 10:30:00' |
| `updated_at` | TIMESTAMP | æ›´æ–°æ—¶é—´ | '2024-10-02 11:00:00' |
| `processed` | BOOLEAN | æ˜¯å¦å·²å¤„ç† | true/false |
| `priority` | INTEGER | ä¼˜å…ˆçº§ | 1, 2, 3 |

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢

### 1. æŸ¥çœ‹æœ€è¿‘çš„åé¦ˆ

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    id,
    site_id,
    LEFT(content, 50) as content,
    rating,
    status,
    created_at
FROM unified_feedback 
ORDER BY created_at DESC 
LIMIT 20;
"
```

---

### 2. æŒ‰ç«™ç‚¹æŸ¥çœ‹

```bash
# Site3
docker exec postgres_master psql -U admin -d postgres -c "
SELECT * FROM unified_feedback 
WHERE site_id = 'site3' 
ORDER BY created_at DESC;
"

# ColorMagic
docker exec postgres_master psql -U admin -d postgres -c "
SELECT * FROM unified_feedback 
WHERE site_id = 'colormagic' 
ORDER BY created_at DESC;
"
```

---

### 3. æŒ‰çŠ¶æ€æŸ¥çœ‹

```bash
# å¾…å¤„ç†
docker exec postgres_master psql -U admin -d postgres -c "
SELECT id, site_id, LEFT(content, 40), created_at 
FROM unified_feedback 
WHERE status = 'pending' 
ORDER BY created_at DESC;
"

# å·²è§£å†³
docker exec postgres_master psql -U admin -d postgres -c "
SELECT id, site_id, LEFT(content, 40), created_at 
FROM unified_feedback 
WHERE status = 'resolved' 
ORDER BY created_at DESC;
"
```

---

### 4. æŒ‰è¯„åˆ†æŸ¥çœ‹

```bash
# é«˜åˆ†åé¦ˆï¼ˆ4-5åˆ†ï¼‰
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, created_at 
FROM unified_feedback 
WHERE rating >= 4 
ORDER BY rating DESC, created_at DESC;
"

# ä½åˆ†åé¦ˆï¼ˆ1-2åˆ†ï¼‰éœ€è¦é‡ç‚¹å…³æ³¨
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, contact, created_at 
FROM unified_feedback 
WHERE rating <= 2 
ORDER BY created_at DESC;
"
```

---

### 5. æŒ‰åˆ†ç±»æŸ¥çœ‹

```bash
# Bug åé¦ˆ
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, created_at 
FROM unified_feedback 
WHERE category = 'bug' 
ORDER BY created_at DESC;
"

# åŠŸèƒ½å»ºè®®
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, created_at 
FROM unified_feedback 
WHERE category = 'feature' 
ORDER BY created_at DESC;
"
```

---

### 6. ç»Ÿè®¡æŸ¥è¯¢

```bash
# å„ç«™ç‚¹ç»Ÿè®¡
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    site_id,
    COUNT(*) as total,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending,
    COUNT(CASE WHEN status = 'resolved' THEN 1 END) as resolved,
    ROUND(AVG(rating), 2) as avg_rating,
    MAX(created_at) as last_feedback
FROM unified_feedback 
WHERE site_id != 'system'
GROUP BY site_id
ORDER BY total DESC;
"

# æŒ‰æ—¥æœŸç»Ÿè®¡
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    DATE(created_at) as date,
    site_id,
    COUNT(*) as count,
    ROUND(AVG(rating), 2) as avg_rating
FROM unified_feedback 
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at), site_id
ORDER BY date DESC, site_id;
"
```

---

### 7. æœç´¢å†…å®¹

```bash
# æœç´¢åŒ…å«ç‰¹å®šå…³é”®è¯çš„åé¦ˆ
docker exec postgres_master psql -U admin -d postgres -c "
SELECT id, site_id, content, rating, created_at 
FROM unified_feedback 
WHERE content LIKE '%é—®é¢˜%' OR content LIKE '%bug%'
ORDER BY created_at DESC;
"
```

---

### 8. æŸ¥çœ‹æœ€è¿‘ä¸€å‘¨çš„åé¦ˆ

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    site_id,
    COUNT(*) as count,
    ROUND(AVG(rating), 2) as avg_rating
FROM unified_feedback 
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY site_id
ORDER BY count DESC;
"
```

---

## ğŸ”§ ç®¡ç†æ“ä½œ

### æ›´æ–°åé¦ˆçŠ¶æ€

```bash
# æ ‡è®°ä¸ºå·²æŸ¥çœ‹
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET status = 'reviewed', updated_at = NOW() 
WHERE id = 1;
"

# æ ‡è®°ä¸ºå·²è§£å†³
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET status = 'resolved', processed = true, updated_at = NOW() 
WHERE id = 1;
"

# æ·»åŠ ç®¡ç†å‘˜å¤‡æ³¨
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET admin_notes = 'å·²è”ç³»ç”¨æˆ·å¹¶è§£å†³é—®é¢˜', updated_at = NOW() 
WHERE id = 1;
"
```

---

### æ‰¹é‡æ›´æ–°

```bash
# æ‰¹é‡æ ‡è®°æ‰€æœ‰å¾…å¤„ç†çš„ä½åˆ†åé¦ˆä¸ºé«˜ä¼˜å…ˆçº§
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET priority = 3, updated_at = NOW() 
WHERE status = 'pending' AND rating <= 2;
"
```

---

### åˆ é™¤æµ‹è¯•æ•°æ®

```bash
# åˆ é™¤æµ‹è¯•åˆ†ç±»çš„åé¦ˆ
docker exec postgres_master psql -U admin -d postgres -c "
DELETE FROM unified_feedback 
WHERE category = 'test';
"

# åˆ é™¤30å¤©å‰çš„å·²è§£å†³åé¦ˆï¼ˆå½’æ¡£ï¼‰
docker exec postgres_master psql -U admin -d postgres -c "
DELETE FROM unified_feedback 
WHERE status = 'resolved' 
  AND created_at < NOW() - INTERVAL '30 days';
"
```

---

## ğŸ“¤ å¯¼å‡ºæ•°æ®

### å¯¼å‡ºä¸º CSV

```bash
# å¯¼å‡ºæ‰€æœ‰åé¦ˆ
docker exec postgres_master psql -U admin -d postgres -c "
COPY (
    SELECT id, site_id, content, category, rating, status, contact, created_at 
    FROM unified_feedback 
    ORDER BY created_at DESC
) TO STDOUT WITH CSV HEADER
" > feedbacks_all.csv

# å¯¼å‡ºç‰¹å®šç«™ç‚¹
docker exec postgres_master psql -U admin -d postgres -c "
COPY (
    SELECT id, content, category, rating, status, contact, created_at 
    FROM unified_feedback 
    WHERE site_id = 'site3'
    ORDER BY created_at DESC
) TO STDOUT WITH CSV HEADER
" > feedbacks_site3.csv
```

---

### å¯¼å‡ºä¸º JSON

```bash
docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT json_agg(row_to_json(t))
FROM (
    SELECT id, site_id, content, category, rating, status, created_at
    FROM unified_feedback
    WHERE site_id = 'site3'
    ORDER BY created_at DESC
) t
" > feedbacks_site3.json
```

---

## ğŸ“Š æ•°æ®åˆ†æç¤ºä¾‹

### åˆ†æç”¨æˆ·æ»¡æ„åº¦è¶‹åŠ¿

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    DATE(created_at) as date,
    COUNT(*) as feedback_count,
    ROUND(AVG(rating), 2) as avg_rating,
    COUNT(CASE WHEN rating >= 4 THEN 1 END) as positive,
    COUNT(CASE WHEN rating <= 2 THEN 1 END) as negative
FROM unified_feedback 
WHERE site_id = 'site3' 
  AND created_at > NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
"
```

---

### åˆ†æå¸¸è§é—®é¢˜åˆ†ç±»

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    category,
    COUNT(*) as count,
    ROUND(AVG(rating), 2) as avg_rating,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending
FROM unified_feedback 
WHERE site_id = 'site3'
GROUP BY category
ORDER BY count DESC;
"
```

---

## ğŸ”” ç›‘æ§å»ºè®®

### è®¾ç½®å®šæœŸæ£€æŸ¥

```bash
# åˆ›å»ºæ£€æŸ¥è„šæœ¬
cat > /docker/db_master/check-feedbacks.sh << 'EOF'
#!/bin/bash
PENDING=$(docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT COUNT(*) FROM unified_feedback WHERE status = 'pending';
" | tr -d ' ')

if [ "$PENDING" -gt "10" ]; then
    echo "âš ï¸ è­¦å‘Šï¼šæœ‰ $PENDING æ¡å¾…å¤„ç†çš„åé¦ˆï¼"
    # å¯ä»¥å‘é€é‚®ä»¶æˆ–é€šçŸ¥
fi
EOF

chmod +x /docker/db_master/check-feedbacks.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©ä¸Šåˆ9ç‚¹æ£€æŸ¥ï¼‰
(crontab -l 2>/dev/null; echo "0 9 * * * /docker/db_master/check-feedbacks.sh") | crontab -
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å®šæœŸæŸ¥çœ‹å¾…å¤„ç†åé¦ˆ**
   ```bash
   ./scripts/view-feedbacks.sh pending
   ```

2. **å…³æ³¨ä½åˆ†åé¦ˆ**
   - ä¼˜å…ˆå¤„ç† 1-2 åˆ†çš„åé¦ˆ
   - åŠæ—¶è”ç³»ç”¨æˆ·äº†è§£é—®é¢˜

3. **åˆ†æè¯„åˆ†è¶‹åŠ¿**
   - æ¯å‘¨æŸ¥çœ‹å¹³å‡è¯„åˆ†
   - å‘ç°é—®é¢˜åŠæ—¶æ”¹è¿›

4. **å½’æ¡£æ—§æ•°æ®**
   - å®šæœŸå¯¼å‡ºå†å²æ•°æ®
   - åˆ é™¤30å¤©å‰çš„å·²è§£å†³åé¦ˆ

5. **ç›‘æ§åé¦ˆé‡**
   - åé¦ˆçªç„¶å¢å¤šå¯èƒ½è¡¨ç¤ºæœ‰é—®é¢˜
   - åé¦ˆå‡å°‘å¯èƒ½éœ€è¦æ”¹è¿›æ”¶é›†æœºåˆ¶

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **åº”ç”¨æ¥å…¥æŒ‡å—**: `åº”ç”¨æ¥å…¥PostgreSQLæ€»ç³»ç»ŸæŒ‡å—.md`
- **ç³»ç»Ÿéƒ¨ç½²æŒ‡å—**: `README.md`
- **æƒé™é—®é¢˜**: `æƒé™é—®é¢˜å¿«é€Ÿè§£å†³æ–¹æ¡ˆ.md`

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-10-02  
**é€‚ç”¨ç³»ç»Ÿ**: PostgreSQL æ€»ç³»ç»Ÿ v2.0

