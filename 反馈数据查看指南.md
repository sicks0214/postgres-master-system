# 反馈数据查看指南

> **PostgreSQL 总系统 - unified_feedback 表管理**  
> **最后更新**: 2024-10-02

---

## 📋 快速开始

### 使用自动化脚本（推荐）⭐

```bash
# 在 VPS 上执行
cd /docker/db_master
chmod +x scripts/view-feedbacks.sh

# 查看所有反馈
./scripts/view-feedbacks.sh

# 查看特定站点
./scripts/view-feedbacks.sh site3
./scripts/view-feedbacks.sh colormagic

# 查看统计信息
./scripts/view-feedbacks.sh stats

# 查看待处理的反馈
./scripts/view-feedbacks.sh pending

# 查看更多反馈（指定数量）
./scripts/view-feedbacks.sh site3 50
```

---

## 📊 unified_feedback 表结构

### 字段说明

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `id` | SERIAL | 主键，自增 | 1, 2, 3... |
| `site_id` | VARCHAR(50) | 站点标识 | 'site3', 'colormagic' |
| `user_id` | UUID | 用户ID（可选） | UUID 或 NULL |
| `content` | TEXT | 反馈内容 | '网站很好用' |
| `contact` | VARCHAR(255) | 联系方式 | 'user@example.com' |
| `rating` | INTEGER | 评分 1-5 | 5 |
| `category` | VARCHAR(50) | 分类 | 'general', 'bug', 'feature' |
| `user_ip` | VARCHAR(45) | 用户IP | '192.168.1.1' |
| `user_agent` | TEXT | 用户代理 | 'Mozilla/5.0...' |
| `status` | VARCHAR(20) | 状态 | 'pending', 'reviewed', 'resolved' |
| `admin_notes` | TEXT | 管理员备注 | '已处理' |
| `created_at` | TIMESTAMP | 创建时间 | '2024-10-02 10:30:00' |
| `updated_at` | TIMESTAMP | 更新时间 | '2024-10-02 11:00:00' |
| `processed` | BOOLEAN | 是否已处理 | true/false |
| `priority` | INTEGER | 优先级 | 1, 2, 3 |

---

## 🔍 常用查询

### 1. 查看最近的反馈

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    id,
    site_id,
    LEFT(content, 50) as content,
    rating,
    status,
    created_at
FROM unified_feedback 
ORDER BY created_at DESC 
LIMIT 20;
"
```

---

### 2. 按站点查看

```bash
# Site3
docker exec postgres_master psql -U admin -d postgres -c "
SELECT * FROM unified_feedback 
WHERE site_id = 'site3' 
ORDER BY created_at DESC;
"

# ColorMagic
docker exec postgres_master psql -U admin -d postgres -c "
SELECT * FROM unified_feedback 
WHERE site_id = 'colormagic' 
ORDER BY created_at DESC;
"
```

---

### 3. 按状态查看

```bash
# 待处理
docker exec postgres_master psql -U admin -d postgres -c "
SELECT id, site_id, LEFT(content, 40), created_at 
FROM unified_feedback 
WHERE status = 'pending' 
ORDER BY created_at DESC;
"

# 已解决
docker exec postgres_master psql -U admin -d postgres -c "
SELECT id, site_id, LEFT(content, 40), created_at 
FROM unified_feedback 
WHERE status = 'resolved' 
ORDER BY created_at DESC;
"
```

---

### 4. 按评分查看

```bash
# 高分反馈（4-5分）
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, created_at 
FROM unified_feedback 
WHERE rating >= 4 
ORDER BY rating DESC, created_at DESC;
"

# 低分反馈（1-2分）需要重点关注
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, contact, created_at 
FROM unified_feedback 
WHERE rating <= 2 
ORDER BY created_at DESC;
"
```

---

### 5. 按分类查看

```bash
# Bug 反馈
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, created_at 
FROM unified_feedback 
WHERE category = 'bug' 
ORDER BY created_at DESC;
"

# 功能建议
docker exec postgres_master psql -U admin -d postgres -c "
SELECT site_id, LEFT(content, 50), rating, created_at 
FROM unified_feedback 
WHERE category = 'feature' 
ORDER BY created_at DESC;
"
```

---

### 6. 统计查询

```bash
# 各站点统计
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    site_id,
    COUNT(*) as total,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending,
    COUNT(CASE WHEN status = 'resolved' THEN 1 END) as resolved,
    ROUND(AVG(rating), 2) as avg_rating,
    MAX(created_at) as last_feedback
FROM unified_feedback 
WHERE site_id != 'system'
GROUP BY site_id
ORDER BY total DESC;
"

# 按日期统计
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    DATE(created_at) as date,
    site_id,
    COUNT(*) as count,
    ROUND(AVG(rating), 2) as avg_rating
FROM unified_feedback 
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at), site_id
ORDER BY date DESC, site_id;
"
```

---

### 7. 搜索内容

```bash
# 搜索包含特定关键词的反馈
docker exec postgres_master psql -U admin -d postgres -c "
SELECT id, site_id, content, rating, created_at 
FROM unified_feedback 
WHERE content LIKE '%问题%' OR content LIKE '%bug%'
ORDER BY created_at DESC;
"
```

---

### 8. 查看最近一周的反馈

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    site_id,
    COUNT(*) as count,
    ROUND(AVG(rating), 2) as avg_rating
FROM unified_feedback 
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY site_id
ORDER BY count DESC;
"
```

---

## 🔧 管理操作

### 更新反馈状态

```bash
# 标记为已查看
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET status = 'reviewed', updated_at = NOW() 
WHERE id = 1;
"

# 标记为已解决
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET status = 'resolved', processed = true, updated_at = NOW() 
WHERE id = 1;
"

# 添加管理员备注
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET admin_notes = '已联系用户并解决问题', updated_at = NOW() 
WHERE id = 1;
"
```

---

### 批量更新

```bash
# 批量标记所有待处理的低分反馈为高优先级
docker exec postgres_master psql -U admin -d postgres -c "
UPDATE unified_feedback 
SET priority = 3, updated_at = NOW() 
WHERE status = 'pending' AND rating <= 2;
"
```

---

### 删除测试数据

```bash
# 删除测试分类的反馈
docker exec postgres_master psql -U admin -d postgres -c "
DELETE FROM unified_feedback 
WHERE category = 'test';
"

# 删除30天前的已解决反馈（归档）
docker exec postgres_master psql -U admin -d postgres -c "
DELETE FROM unified_feedback 
WHERE status = 'resolved' 
  AND created_at < NOW() - INTERVAL '30 days';
"
```

---

## 📤 导出数据

### 导出为 CSV

```bash
# 导出所有反馈
docker exec postgres_master psql -U admin -d postgres -c "
COPY (
    SELECT id, site_id, content, category, rating, status, contact, created_at 
    FROM unified_feedback 
    ORDER BY created_at DESC
) TO STDOUT WITH CSV HEADER
" > feedbacks_all.csv

# 导出特定站点
docker exec postgres_master psql -U admin -d postgres -c "
COPY (
    SELECT id, content, category, rating, status, contact, created_at 
    FROM unified_feedback 
    WHERE site_id = 'site3'
    ORDER BY created_at DESC
) TO STDOUT WITH CSV HEADER
" > feedbacks_site3.csv
```

---

### 导出为 JSON

```bash
docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT json_agg(row_to_json(t))
FROM (
    SELECT id, site_id, content, category, rating, status, created_at
    FROM unified_feedback
    WHERE site_id = 'site3'
    ORDER BY created_at DESC
) t
" > feedbacks_site3.json
```

---

## 📊 数据分析示例

### 分析用户满意度趋势

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    DATE(created_at) as date,
    COUNT(*) as feedback_count,
    ROUND(AVG(rating), 2) as avg_rating,
    COUNT(CASE WHEN rating >= 4 THEN 1 END) as positive,
    COUNT(CASE WHEN rating <= 2 THEN 1 END) as negative
FROM unified_feedback 
WHERE site_id = 'site3' 
  AND created_at > NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
"
```

---

### 分析常见问题分类

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    category,
    COUNT(*) as count,
    ROUND(AVG(rating), 2) as avg_rating,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending
FROM unified_feedback 
WHERE site_id = 'site3'
GROUP BY category
ORDER BY count DESC;
"
```

---

## 🔔 监控建议

### 设置定期检查

```bash
# 创建检查脚本
cat > /docker/db_master/check-feedbacks.sh << 'EOF'
#!/bin/bash
PENDING=$(docker exec postgres_master psql -U admin -d postgres -t -c "
SELECT COUNT(*) FROM unified_feedback WHERE status = 'pending';
" | tr -d ' ')

if [ "$PENDING" -gt "10" ]; then
    echo "⚠️ 警告：有 $PENDING 条待处理的反馈！"
    # 可以发送邮件或通知
fi
EOF

chmod +x /docker/db_master/check-feedbacks.sh

# 添加到 crontab（每天上午9点检查）
(crontab -l 2>/dev/null; echo "0 9 * * * /docker/db_master/check-feedbacks.sh") | crontab -
```

---

## 💡 最佳实践

1. **定期查看待处理反馈**
   ```bash
   ./scripts/view-feedbacks.sh pending
   ```

2. **关注低分反馈**
   - 优先处理 1-2 分的反馈
   - 及时联系用户了解问题

3. **分析评分趋势**
   - 每周查看平均评分
   - 发现问题及时改进

4. **归档旧数据**
   - 定期导出历史数据
   - 删除30天前的已解决反馈

5. **监控反馈量**
   - 反馈突然增多可能表示有问题
   - 反馈减少可能需要改进收集机制

---

## 📞 相关文档

- **应用接入指南**: `应用接入PostgreSQL总系统指南.md`
- **系统部署指南**: `README.md`
- **权限问题**: `权限问题快速解决方案.md`

---

**版本**: v1.0  
**最后更新**: 2024-10-02  
**适用系统**: PostgreSQL 总系统 v2.0

