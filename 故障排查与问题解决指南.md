# PostgreSQL æ€»ç³»ç»Ÿ - æ•…éšœæ’æŸ¥ä¸é—®é¢˜è§£å†³æŒ‡å—

> **ç»¼åˆç»´ä¿®æ–‡æ¡£**  
> **ç‰ˆæœ¬**: v3.0  
> **æœ€åæ›´æ–°**: 2024-10-03  
> **é€‚ç”¨ç³»ç»Ÿ**: PostgreSQL æ€»ç³»ç»Ÿ v2.0+

---

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿè¯Šæ–­æµç¨‹](#å¿«é€Ÿè¯Šæ–­æµç¨‹)
2. [æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ](#æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ)
3. [æ•°æ®åº“è¿æ¥é—®é¢˜](#æ•°æ®åº“è¿æ¥é—®é¢˜)
4. [è¡¨ç»“æ„é—®é¢˜](#è¡¨ç»“æ„é—®é¢˜)
5. [ä»£ç é€‚é…é—®é¢˜](#ä»£ç é€‚é…é—®é¢˜)
6. [éƒ¨ç½²é—®é¢˜](#éƒ¨ç½²é—®é¢˜)
7. [æ€§èƒ½é—®é¢˜](#æ€§èƒ½é—®é¢˜)
8. [æ•°æ®é—®é¢˜](#æ•°æ®é—®é¢˜)
9. [å†å²é—®é¢˜è®°å½•](#å†å²é—®é¢˜è®°å½•)

---

## ğŸš¨ å¿«é€Ÿè¯Šæ–­æµç¨‹

é‡åˆ°é—®é¢˜æ—¶ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºè¯Šæ–­ï¼š

### ç¬¬ä¸€æ­¥ï¼šç¡®å®šé—®é¢˜ç±»å‹

```bash
# 1. æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps | grep postgres_master

# 2. æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
docker logs postgres_master --tail 50

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network inspect shared_net | grep postgres
```

### ç¬¬äºŒæ­¥ï¼šæ ¹æ®é”™è¯¯ä¿¡æ¯åˆ†ç±»

| é”™è¯¯ä¿¡æ¯ | é—®é¢˜ç±»å‹ | è·³è½¬ç« èŠ‚ |
|---------|---------|---------|
| `permission denied for table` | æƒé™é—®é¢˜ | [æƒé™é—®é¢˜](#æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ) |
| `getaddrinfo ENOTFOUND` | ç½‘ç»œé—®é¢˜ | [è¿æ¥é—®é¢˜](#æ•°æ®åº“è¿æ¥é—®é¢˜) |
| `relation "xxx" does not exist` | è¡¨åé—®é¢˜ | [è¡¨ç»“æ„é—®é¢˜](#è¡¨ç»“æ„é—®é¢˜) |
| `password authentication failed` | è®¤è¯é—®é¢˜ | [è¿æ¥é—®é¢˜](#æ•°æ®åº“è¿æ¥é—®é¢˜) |
| `connection pool exhausted` | æ€§èƒ½é—®é¢˜ | [æ€§èƒ½é—®é¢˜](#æ€§èƒ½é—®é¢˜) |

---

## ğŸ” æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ç—‡çŠ¶

```
ERROR: permission denied for table xxx_users
ERROR: permission denied for table site3__users
ERROR: permission denied for sequence xxx_id_seq
```

### ğŸš€ å¿«é€Ÿè§£å†³ï¼ˆ3æ­¥ï¼‰â­

#### æ–¹æ³•1: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæœ€æ¨èï¼‰

```bash
# åœ¨ VPS ä¸Šæ‰§è¡Œ
cd /docker/db_master
chmod +x scripts/fix-permissions.sh

# ä¿®å¤æƒé™ï¼ˆæ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·åï¼‰
./scripts/fix-permissions.sh site3_user
./scripts/fix-permissions.sh colormagic_user
```

#### æ–¹æ³•2: æ‰‹åŠ¨æ‰§è¡Œï¼ˆå¿«é€Ÿæœ‰æ•ˆï¼‰

```bash
# ä¸€é”®æˆäºˆæ‰€æœ‰æƒé™ï¼ˆæœ€ç®€å•ï¼‰
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"

docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"

# éªŒè¯æƒé™
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
 count 
-------
     0
(1 row)
```

#### æ–¹æ³•3: å®Œæ•´é‡ç½®ï¼ˆå¦‚æœä»¥ä¸Šæ–¹æ³•æ— æ•ˆï¼‰

```bash
# è®¾ç½®å˜é‡
SITE_USER="site3_user"
SITE_PASSWORD="site3_prod_pass_2024"

# å®Œå…¨é‡ç½®ç”¨æˆ·å’Œæƒé™
docker exec postgres_master psql -U admin -d postgres -c "
-- æ’¤é”€æ—§æƒé™
REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM $SITE_USER;
REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public FROM $SITE_USER;

-- åˆ é™¤å¹¶é‡æ–°åˆ›å»ºç”¨æˆ·
DROP USER IF EXISTS $SITE_USER;
CREATE USER $SITE_USER WITH PASSWORD '$SITE_PASSWORD';

-- æˆäºˆåŸºç¡€æƒé™
GRANT CONNECT ON DATABASE postgres TO $SITE_USER;
GRANT USAGE ON SCHEMA public TO $SITE_USER;

-- æˆäºˆè¡¨å’Œåºåˆ—æƒé™
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"

# æµ‹è¯•
docker exec postgres_master psql -U $SITE_USER -d postgres -c "SELECT current_user, COUNT(*) FROM site3__users;"
```

---

### ğŸ“Š æƒé™è¯Šæ–­æµç¨‹

#### 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨

```bash
docker exec postgres_master psql -U admin -d postgres -c "\du site3_user"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
      Role name       |  Attributes  
----------------------+--------------
 site3_user           |              
```

**å¦‚æœä¸å­˜åœ¨**ï¼Œéœ€è¦å…ˆåˆ›å»ºï¼š
```bash
docker exec postgres_master psql -U admin -d postgres -c "
CREATE USER site3_user WITH PASSWORD 'site3_prod_pass_2024';
"
```

---

#### 2. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨

```bash
docker exec postgres_master psql -U admin -d postgres -c "\dt site3__*"
```

**å¦‚æœè¡¨ä¸å­˜åœ¨**ï¼Œéœ€è¦å…ˆåˆ›å»ºè¡¨ï¼ˆè¿è¡Œåº”ç”¨çš„åˆå§‹åŒ–è„šæœ¬ï¼‰ã€‚

---

#### 3. æ£€æŸ¥å½“å‰æƒé™

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT grantee, table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' AND table_name LIKE 'site3__%'
ORDER BY table_name;
"
```

**å¦‚æœè¿”å› 0 è¡Œ**ï¼Œè¯´æ˜æ²¡æœ‰æƒé™ï¼Œéœ€è¦æˆæƒã€‚

---

#### 4. æ£€æŸ¥è¡¨çš„æ‰€æœ‰è€…

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT schemaname, tablename, tableowner 
FROM pg_tables 
WHERE tablename LIKE 'site3__%';
"
```

**æ‰€æœ‰è€…åº”è¯¥æ˜¯ `admin`**ã€‚å¦‚æœä¸æ˜¯ï¼Œå¯èƒ½å¯¼è‡´æƒé™é—®é¢˜ã€‚

---

### âœ… å®Œæ•´éªŒè¯æ£€æŸ¥æ¸…å•

æ‰§è¡Œä»¥ä¸‹æ‰€æœ‰æµ‹è¯•ï¼Œç¡®è®¤æƒé™å®Œå…¨æ­£å¸¸ï¼š

```bash
# âœ… 1. ç”¨æˆ·å¯ä»¥è¿æ¥
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT current_user;"

# âœ… 2. ç”¨æˆ·å¯ä»¥è¯»å–è¡¨
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"

# âœ… 3. ç”¨æˆ·å¯ä»¥æ’å…¥æ•°æ®
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO site3__users (username, email, password_hash) 
VALUES ('testuser', 'test@site3.com', 'test123') 
ON CONFLICT (email) DO NOTHING;
"

# âœ… 4. ç”¨æˆ·å¯ä»¥æ›´æ–°æ•°æ®
docker exec postgres_master psql -U site3_user -d postgres -c "
UPDATE site3__users SET password_hash = 'new_hash' WHERE username = 'testuser';
"

# âœ… 5. ç”¨æˆ·å¯ä»¥è®¿é—® unified_feedback
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO unified_feedback (site_id, content, category) 
VALUES ('site3', 'æµ‹è¯•åé¦ˆ', 'test') 
RETURNING id, site_id, content;
"

# âœ… 6. æŸ¥çœ‹æ‰€æœ‰æƒé™
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' 
ORDER BY table_name;
"
```

**å¦‚æœä»¥ä¸Š 6 ä¸ªæµ‹è¯•éƒ½é€šè¿‡ï¼Œæƒé™é…ç½®å®Œå…¨æ­£å¸¸ï¼** âœ…

---

### ğŸ¯ ä¸åŒç«™ç‚¹çš„æƒé™ä¿®å¤å‘½ä»¤

#### Site3
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"
```

#### ColorMagic (Site4)
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO colormagic_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO colormagic_user;"
```

#### Site1
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site1_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site1_user;"
```

---

### âŒ å¸¸è§é”™è¯¯å’ŒåŸå› 

#### é”™è¯¯1: DO ä»£ç å—ä¸æ‰§è¡Œ

**ç—‡çŠ¶**ï¼šè¿è¡Œ DO ä»£ç å—åæ²¡æœ‰ä»»ä½•è¾“å‡º

**åŸå› **ï¼šæŸäº› shell ç¯å¢ƒä¸­ï¼Œheredoc æ–¹å¼çš„ DO ä»£ç å—å¯èƒ½é™é»˜å¤±è´¥

**è§£å†³**ï¼šä½¿ç”¨ `-c` å‚æ•°ç›´æ¥æ‰§è¡Œç®€å•çš„ GRANT å‘½ä»¤

```bash
# âŒ å¯èƒ½å¤±è´¥
docker exec postgres_master psql -U admin -d postgres << 'EOF'
DO $$
BEGIN
    GRANT ALL PRIVILEGES ON site3__users TO site3_user;
END $$;
EOF

# âœ… æ¨èæ–¹å¼
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
```

---

#### é”™è¯¯2: GRANT å‘½ä»¤æ²¡æœ‰è¾“å‡º

**ç—‡çŠ¶**ï¼šæ‰§è¡Œ GRANT åæ²¡æœ‰çœ‹åˆ° "GRANT" å­—æ ·

**åŸå› **ï¼šå‘½ä»¤å¯èƒ½æ²¡æœ‰çœŸæ­£æ‰§è¡Œ

**è§£å†³**ï¼šç¡®ä¿ä½¿ç”¨ `-c` å‚æ•°ï¼Œå¹¶æ£€æŸ¥è¿”å›ç 

```bash
# æ­£ç¡®çš„æ‰§è¡Œæ–¹å¼
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"

# åº”è¯¥çœ‹åˆ°è¾“å‡ºï¼š
# GRANT
```

---

#### é”™è¯¯3: æƒé™æŸ¥è¯¢è¿”å› 0 è¡Œ

**ç—‡çŠ¶**ï¼š
```sql
SELECT grantee, table_name FROM information_schema.table_privileges WHERE grantee = 'site3_user';
-- è¿”å› 0 rows
```

**åŸå› **ï¼šæƒé™ç¡®å®æ²¡æœ‰æˆäºˆæˆåŠŸ

**è§£å†³**ï¼šé‡æ–°æ‰§è¡Œæˆæƒå‘½ä»¤ï¼Œå¹¶ç¡®ä¿çœ‹åˆ° "GRANT" è¾“å‡º

---

### ğŸ’¡ é¢„é˜²æªæ–½

#### åœ¨åˆ›å»ºæ–°ç«™ç‚¹è¡¨æ—¶ï¼Œç«‹å³æˆæƒ

```bash
# åˆ›å»ºè¡¨åç«‹å³æˆæƒ
SITE_USER="site5_user"

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬åˆ›å»ºè¡¨
cat init-site5.sql | docker exec -i postgres_master psql -U admin -d postgres

# ç«‹å³æˆæƒ
docker exec postgres_master psql -U admin -d postgres -c "
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"
```

---

## ğŸ”Œ æ•°æ®åº“è¿æ¥é—®é¢˜

### é—®é¢˜1: æ— æ³•è¿æ¥åˆ° postgres_master

**ç—‡çŠ¶ï¼š**
```
Error: getaddrinfo ENOTFOUND postgres_master
```

**åŸå› **ï¼šåº”ç”¨å®¹å™¨ä¸åœ¨ `shared_net` ç½‘ç»œä¸­

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ shared_net ç½‘ç»œæ˜¯å¦å­˜åœ¨
docker network ls | grep shared_net

# å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
docker network create shared_net

# 2. æ£€æŸ¥åº”ç”¨å®¹å™¨æ˜¯å¦åœ¨ç½‘ç»œä¸­
docker network inspect shared_net | grep -A 5 your-app

# 3. å¦‚æœæ²¡æœ‰ï¼Œè¿æ¥ç½‘ç»œ
docker network connect shared_net your-app

# 4. é‡å¯åº”ç”¨
docker restart your-app

# 5. æµ‹è¯• DNS è§£æ
docker exec your-app ping -c 2 postgres_master

# 6. æµ‹è¯•ç«¯å£è¿æ¥
docker exec your-app nc -zv postgres_master 5432
```

---

### é—®é¢˜2: å¯†ç è®¤è¯å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
Error: password authentication failed for user "colormagic_user"
```

**åŸå› **ï¼š`.env` æ–‡ä»¶ä¸­çš„å¯†ç ä¸æ­£ç¡®

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ .env å¯†ç 
cat /docker/your-app/.env | grep DB_PASSWORD

# 2. æ£€æŸ¥ PostgreSQL ä¸­çš„æ­£ç¡®å¯†ç 
# åº”è¯¥æ˜¯ï¼šColorMagic_VPS_2024_Secure_Passï¼ˆSite4ï¼‰
# æˆ–ï¼šsite1_prod_pass_2024ï¼ˆSite1ï¼‰

# 3. æ›´æ–° .env æ–‡ä»¶
nano /docker/your-app/.env
# ä¿®æ”¹ DB_PASSWORD=æ­£ç¡®çš„å¯†ç 

# 4. é‡å¯åº”ç”¨
docker restart your-app

# 5. æŸ¥çœ‹æ—¥å¿—éªŒè¯
docker logs your-app --tail 30
```

**æˆ–è€…é‡ç½® PostgreSQL ä¸­çš„å¯†ç ï¼š**

```bash
# é‡ç½®å¯†ç 
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER colormagic_user WITH PASSWORD 'NewPassword123';
"

# åŒæ­¥æ›´æ–°åº”ç”¨çš„.envæ–‡ä»¶
```

---

### é—®é¢˜3: è¿æ¥æ± è€—å°½

**ç—‡çŠ¶ï¼š**
```
Error: remaining connection slots are reserved
Error: connection pool exhausted
```

**åŸå› **ï¼šè¿æ¥æ•°è¶…è¿‡é™åˆ¶

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥å½“å‰è¿æ¥æ•°
docker exec postgres_master psql -U admin -d postgres -c "
SELECT count(*) as connections, usename 
FROM pg_stat_activity 
GROUP BY usename;
"

# 2. å‡å°‘åº”ç”¨çš„è¿æ¥æ± å¤§å°
nano /docker/your-app/.env
# ä¿®æ”¹ï¼šDB_MAX_CONNECTIONS=10

# 3. æ¸…ç†ç©ºé—²è¿æ¥
docker exec postgres_master psql -U admin -d postgres -c "
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'idle' AND state_change < now() - interval '5 minutes';
"

# 4. å¢åŠ  PostgreSQL æœ€å¤§è¿æ¥æ•°ï¼ˆå¦‚éœ€è¦ï¼‰
# ç¼–è¾‘ docker-compose.vps.ymlï¼Œä¿®æ”¹ max_connections

# 5. é‡å¯åº”ç”¨
docker restart your-app
```

---

### é—®é¢˜4: ç«¯å£è¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
Error: connect ECONNREFUSED 5432
```

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ PostgreSQL å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps | grep postgres_master

# 2. æ£€æŸ¥ç«¯å£æ˜ å°„
docker port postgres_master

# 3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®ï¼ˆå¦‚æœä»å¤–éƒ¨è¿æ¥ï¼‰
sudo ufw status
sudo ufw allow 5432/tcp

# 4. æ£€æŸ¥ PostgreSQL ç›‘å¬é…ç½®
docker exec postgres_master psql -U admin -d postgres -c "SHOW listen_addresses;"

# 5. é‡å¯ PostgreSQL å®¹å™¨
docker restart postgres_master
```

---

## ğŸ“‹ è¡¨ç»“æ„é—®é¢˜

### é—®é¢˜1: è¡¨ä¸å­˜åœ¨

**ç—‡çŠ¶ï¼š**
```
Error: relation "users" does not exist
Error: relation "colormagic_users" does not exist
```

**åŸå› åŠè§£å†³ï¼š**

#### åŸå› 1: ä»£ç ä¸­ä½¿ç”¨äº†ä¸å¸¦å‰ç¼€çš„è¡¨å

```javascript
// âŒ é”™è¯¯ä»£ç 
const query = 'SELECT * FROM users';  

// âœ… ä¿®æ”¹ä¸º
const query = 'SELECT * FROM colormagic_users';  

// ğŸ’¡ æˆ–ä½¿ç”¨é…ç½®
const { TABLES } = require('./config/database');
const query = `SELECT * FROM ${TABLES.USERS}`;
```

#### åŸå› 2: åˆå§‹åŒ–è„šæœ¬æœªæ‰§è¡Œ

```bash
# 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
docker exec postgres_master psql -U admin -d postgres -c "\dt colormagic_*"

# 2. å¦‚æœæ²¡æœ‰è¡¨ï¼Œæ£€æŸ¥åˆå§‹åŒ–æ—¥å¿—
docker logs postgres_master | grep -i "åˆå§‹åŒ–\|creating\|created"

# 3. å®Œå…¨é‡æ–°åˆå§‹åŒ–ï¼ˆä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼ï¼‰
docker compose -f docker-compose.vps.yml down -v
docker volume rm postgres_master_postgres_data
docker compose -f docker-compose.vps.yml up -d

# 4. æˆ–æ‰‹åŠ¨æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
cat init-scripts/02_site4_colormagic.sql | \
  docker exec -i postgres_master psql -U admin -d postgres
```

---

### é—®é¢˜2: å­—æ®µä¸å­˜åœ¨

**ç—‡çŠ¶ï¼š**
```
Error: column "processed_width" does not exist
```

**è§£å†³ï¼š**

```bash
# 1. æŸ¥çœ‹è¡¨ç»“æ„
docker exec postgres_master psql -U admin -d postgres -c "\d colormagic_color_analysis"

# 2. å¦‚æœç¼ºå°‘å­—æ®µï¼Œæ·»åŠ å­—æ®µ
docker exec postgres_master psql -U admin -d postgres -c "
ALTER TABLE colormagic_color_analysis 
ADD COLUMN processed_width INTEGER,
ADD COLUMN processed_height INTEGER;
"

# 3. éªŒè¯å­—æ®µå·²æ·»åŠ 
docker exec postgres_master psql -U admin -d postgres -c "\d colormagic_color_analysis"
```

---

### é—®é¢˜3: è¡¨åä¸åŒ¹é…

**ç—‡çŠ¶ï¼š**åº”ç”¨æ­£å¸¸è¿è¡Œä½†æ•°æ®æ²¡æœ‰ä¿å­˜

**åŸå› ï¼š**ä»£ç ä¸­çš„è¡¨åä¸æ•°æ®åº“å®é™…è¡¨åä¸ä¸€è‡´

**æ£€æŸ¥å’Œä¿®å¤ï¼š**

```bash
# 1. åˆ—å‡ºæ‰€æœ‰è¡¨
docker exec postgres_master psql -U admin -d postgres -c "\dt"

# 2. æ£€æŸ¥ä»£ç ä¸­ä½¿ç”¨çš„è¡¨å
grep -r "FROM.*users" backend/src/  # æœç´¢ä»£ç ä¸­çš„è¡¨å

# 3. ç¡®ä¿è¡¨åæ˜ å°„æ­£ç¡®
```

**Site4 (ColorMagic) è¡¨åæ˜ å°„ï¼š**

| ä»£ç ä¸­å¯èƒ½çš„è¡¨å | PostgreSQL å®é™…è¡¨å |
|----------------|-------------------|
| `users` | `colormagic_users` |
| `sessions` | `colormagic_sessions` |
| `analysis_history` | `colormagic_color_analysis` |
| `user_analysis_history` | `colormagic_analysis_history` |
| `palettes` | `colormagic_palettes` |
| `feedback` | `unified_feedback` (WHERE site_id='colormagic') |

---

## ğŸ’» ä»£ç é€‚é…é—®é¢˜

### é—®é¢˜1: authService.ts è¡¨åä¸åŒ¹é…

**å½±å“**ï¼šç”¨æˆ·è®¤è¯ç³»ç»Ÿå®Œå…¨æ— æ³•å·¥ä½œ

**é”™è¯¯çš„è¡¨åï¼š**
- `users` â†’ åº”è¯¥æ˜¯ `colormagic_users`
- `user_sessions` â†’ åº”è¯¥æ˜¯ `colormagic_sessions`
- `user_analysis_history` â†’ åº”è¯¥æ˜¯ `colormagic_analysis_history`
- `user_favorite_palettes` â†’ åº”è¯¥æ˜¯ `colormagic_palettes`
- `user_usage_stats` â†’ åº”è¯¥æ˜¯ `colormagic_usage_stats`

**ä¿®å¤æ–¹æ³•ï¼ˆæœ¬åœ°æ“ä½œï¼‰ï¼š**

```bash
# åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
cd backend/src/services/auth

# å¤‡ä»½åŸæ–‡ä»¶
cp authService.ts authService.ts.backup

# æ‰¹é‡æ›¿æ¢è¡¨å
sed -i 's/FROM users/FROM colormagic_users/g' authService.ts
sed -i 's/INSERT INTO users/INSERT INTO colormagic_users/g' authService.ts
sed -i 's/UPDATE users/UPDATE colormagic_users/g' authService.ts
sed -i 's/user_sessions/colormagic_sessions/g' authService.ts
sed -i 's/user_analysis_history/colormagic_analysis_history/g' authService.ts
sed -i 's/user_favorite_palettes/colormagic_palettes/g' authService.ts
sed -i 's/user_usage_stats/colormagic_usage_stats/g' authService.ts

# ç¼–è¯‘ TypeScript
cd ../../../
npm run build

# Git æäº¤
git add .
git commit -m "fix: update table names to match PostgreSQL schema"
git push origin main

# VPS ä¸Šæ‹‰å–æ›´æ–°
# åœ¨ VPS æ‰§è¡Œï¼š
# cd /docker/site4
# git pull origin main
# cd backend && npm run build && cd ..
# docker restart site4
```

---

### é—®é¢˜2: postgresService.ts æ’å…¥é”™è¯¯çš„è¡¨

**å½±å“**ï¼šé¢œè‰²åˆ†æè®°å½•ä¿å­˜å¤±è´¥

**é”™è¯¯ä½ç½®**ï¼š`backend/src/services/database/postgresService.ts` ç¬¬116è¡Œ

**é”™è¯¯ä»£ç ï¼š**
```typescript
INSERT INTO colormagic_analysis_history (...)  // âŒ é”™è¯¯çš„è¡¨
```

**æ­£ç¡®ä»£ç ï¼š**
```typescript
INSERT INTO colormagic_color_analysis (...)  // âœ… æ­£ç¡®çš„è¡¨
```

**åŸå› è¯´æ˜ï¼š**
- `colormagic_analysis_history` - ç”¨æˆ·å…³è”çš„åˆ†æå†å²ï¼ˆéœ€è¦user_idï¼‰
- `colormagic_color_analysis` - ç‹¬ç«‹çš„é¢œè‰²åˆ†æè®°å½•ï¼ˆæ”¯æŒåŒ¿åè®¿é—®ï¼‰

postgresService.ts çš„ saveColorAnalysis åº”è¯¥ä½¿ç”¨åè€…ã€‚

**ä¿®å¤æ­¥éª¤ï¼š**

```bash
# æœ¬åœ°ä¿®æ”¹
nano backend/src/services/database/postgresService.ts

# ç¬¬116è¡Œï¼Œä¿®æ”¹è¡¨å
# INSERT INTO colormagic_analysis_history
# æ”¹ä¸º
# INSERT INTO colormagic_color_analysis

# ç¼–è¯‘
npm run build

# æäº¤
git add .
git commit -m "fix: correct table name in postgresService"
git push

# VPS éƒ¨ç½²
# ...
```

---

### é—®é¢˜3: åé¦ˆè¡¨ site_id æœªè®¾ç½®

**ç—‡çŠ¶**ï¼šæŸ¥è¯¢åˆ°å…¶ä»–ç«™ç‚¹çš„åé¦ˆæ•°æ®

**åŸå› **ï¼šæŸ¥è¯¢æ—¶æœªè¿‡æ»¤ `site_id`

**é”™è¯¯ä»£ç ï¼š**
```javascript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è¿‡æ»¤ site_id
const query = 'SELECT * FROM unified_feedback';
```

**æ­£ç¡®ä»£ç ï¼š**
```javascript
// âœ… æ­£ç¡®ï¼šå¿…é¡»è¿‡æ»¤ site_id
const siteId = process.env.SITE_ID || 'colormagic';
const query = 'SELECT * FROM unified_feedback WHERE site_id = $1';
const result = await db.query(query, [siteId]);
```

---

## ğŸš€ éƒ¨ç½²é—®é¢˜

### é—®é¢˜1: å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶ï¼š**å®¹å™¨å¯åŠ¨åç«‹å³é€€å‡º

**è¯Šæ–­æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps -a | grep postgres

# 2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs postgres_master --tail 100

# 3. æŸ¥çœ‹å®¹å™¨é€€å‡ºä»£ç 
docker inspect postgres_master | grep -A 5 "State"
```

**å¸¸è§åŸå› åŠè§£å†³ï¼š**

#### åŸå› 1: ç«¯å£å†²çª

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :5432
sudo netstat -tulpn | grep 5432

# è§£å†³æ–¹æ³•1: ä¿®æ”¹ç«¯å£
# ç¼–è¾‘ docker-compose.vps.yml
ports:
  - "5433:5432"  # æ”¹ä¸º5433æˆ–å…¶ä»–ç«¯å£

# è§£å†³æ–¹æ³•2: åœæ­¢å ç”¨ç«¯å£çš„æœåŠ¡
sudo systemctl stop postgresql  # å¦‚æœæ˜¯ç³»ç»Ÿè‡ªå¸¦çš„PostgreSQL
```

#### åŸå› 2: æ•°æ®å·å†²çª

```bash
# åˆ é™¤æ—§çš„æ•°æ®å·
docker compose down -v
docker volume rm postgres_master_postgres_data

# é‡æ–°å¯åŠ¨
docker compose -f docker-compose.vps.yml up -d
```

#### åŸå› 3: å†…å­˜ä¸è¶³

```bash
# æ£€æŸ¥ç³»ç»Ÿå†…å­˜
free -h

# æ£€æŸ¥Dockerå†…å­˜é™åˆ¶
docker stats postgres_master

# å¦‚æœå†…å­˜ä¸è¶³ï¼Œæ¸…ç†ç³»ç»Ÿ
docker system prune -a
```

---

### é—®é¢˜2: åˆå§‹åŒ–è„šæœ¬æœªæ‰§è¡Œ

**ç—‡çŠ¶ï¼š**å®¹å™¨è¿è¡Œæ­£å¸¸ï¼Œä½†è¡¨ä¸å­˜åœ¨

**åŸå› ï¼š**Dockerå·å·²å­˜åœ¨æ•°æ®ï¼Œåˆå§‹åŒ–è„šæœ¬è¢«è·³è¿‡

**è§£å†³ï¼š**

```bash
# æ–¹æ³•1: å®Œå…¨é‡æ–°åˆå§‹åŒ–ï¼ˆä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼ï¼‰
docker compose down -v
docker volume rm postgres_master_postgres_data
docker compose -f docker-compose.vps.yml up -d

# æ–¹æ³•2: æ‰‹åŠ¨æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
cd /docker/db_master
cat init-scripts/01_unified_feedback.sql | docker exec -i postgres_master psql -U admin -d postgres
cat init-scripts/02_site4_colormagic.sql | docker exec -i postgres_master psql -U admin -d postgres
cat init-scripts/03_sites_and_functions.sql | docker exec -i postgres_master psql -U admin -d postgres
```

---

### é—®é¢˜3: åº”ç”¨æ— æ³•è¿æ¥æ•°æ®åº“ï¼ˆç½‘ç»œé—®é¢˜ï¼‰

**ç—‡çŠ¶ï¼š**åº”ç”¨å¯åŠ¨æ­£å¸¸ï¼Œä½†æ— æ³•è¿æ¥æ•°æ®åº“

**è¯Šæ–­å’Œè§£å†³ï¼š**

```bash
# 1. æ£€æŸ¥ç½‘ç»œ
docker network inspect shared_net

# 2. æ£€æŸ¥åº”ç”¨æ˜¯å¦åœ¨ç½‘ç»œä¸­
docker network inspect shared_net | grep your-app

# 3. è¿æ¥ç½‘ç»œ
docker network connect shared_net your-app

# 4. æµ‹è¯•è¿æ¥
docker exec your-app ping -c 2 postgres_master
docker exec your-app nc -zv postgres_master 5432

# 5. æ£€æŸ¥åº”ç”¨ç¯å¢ƒå˜é‡
docker exec your-app env | grep DB_

# 6. é‡å¯åº”ç”¨
docker restart your-app
```

---

### é—®é¢˜4: å¥åº·æ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**å®¹å™¨ä¸æ–­é‡å¯

**è¯Šæ–­ï¼š**

```bash
# æŸ¥çœ‹å¥åº·æ£€æŸ¥çŠ¶æ€
docker inspect postgres_master | grep -A 10 "Health"

# æŸ¥çœ‹æ—¥å¿—
docker logs postgres_master --tail 50
```

**è§£å†³ï¼š**

```bash
# æ‰‹åŠ¨æ‰§è¡Œå¥åº·æ£€æŸ¥å‘½ä»¤
docker exec postgres_master pg_isready -U admin -d postgres

# å¦‚æœå¤±è´¥ï¼Œæ£€æŸ¥PostgreSQLæ˜¯å¦æ­£å¸¸å¯åŠ¨
docker exec postgres_master psql -U admin -d postgres -c "SELECT version();"
```

---

## âš¡ æ€§èƒ½é—®é¢˜

### é—®é¢˜1: æŸ¥è¯¢é€Ÿåº¦æ…¢

**è¯Šæ–­ï¼š**

```bash
# æŸ¥çœ‹æ…¢æŸ¥è¯¢
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    pid,
    now() - query_start as duration,
    query
FROM pg_stat_activity
WHERE state = 'active' AND query NOT LIKE '%pg_stat_activity%'
ORDER BY duration DESC;
"
```

**è§£å†³ï¼š**

```bash
# 1. åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
docker exec postgres_master psql -U admin -d postgres -c "ANALYZE;"

# 2. æŸ¥çœ‹ç¼ºå¤±çš„ç´¢å¼•
docker exec postgres_master psql -U admin -d postgres -c "
SELECT schemaname, tablename 
FROM pg_tables 
WHERE schemaname = 'public';
"

# 3. ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
docker exec postgres_master psql -U admin -d postgres -c "
CREATE INDEX idx_custom ON colormagic_users(email);
"
```

---

### é—®é¢˜2: æ•°æ®åº“è¿‡å¤§

**è¯Šæ–­ï¼š**

```bash
# æŸ¥çœ‹æ•°æ®åº“å¤§å°
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;
"

# æŸ¥çœ‹è¡¨å¤§å°
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
"
```

**è§£å†³ï¼š**

```bash
# 1. æ¸…ç†è¿‡æœŸä¼šè¯
docker exec postgres_master psql -U admin -d postgres -c "SELECT cleanup_expired_sessions();"

# 2. æ¸…ç†æ­»è¡Œï¼ˆVACUUMï¼‰
docker exec postgres_master psql -U admin -d postgres -c "VACUUM;"

# 3. å½’æ¡£æ—§æ•°æ®ï¼ˆç¤ºä¾‹ï¼šå½’æ¡£30å¤©å‰çš„åé¦ˆï¼‰
docker exec postgres_master psql -U admin -d postgres -c "
DELETE FROM unified_feedback 
WHERE status = 'resolved' 
  AND created_at < NOW() - INTERVAL '30 days';
"

# 4. å®Œå…¨æ¸…ç†å’Œåˆ†æï¼ˆéœ€è¦åœæœºç»´æŠ¤æ—¶é—´ï¼‰
docker exec postgres_master psql -U admin -d postgres -c "VACUUM FULL ANALYZE;"
```

---

## ğŸ“Š æ•°æ®é—®é¢˜

### é—®é¢˜1: æ•°æ®ä¸¢å¤±

**ç—‡çŠ¶ï¼š**ä¹‹å‰çš„æ•°æ®çªç„¶æ¶ˆå¤±

**å¯èƒ½åŸå› ï¼š**

1. **å®¹å™¨è¢«åˆ é™¤å¹¶é‡å»º**
2. **æ•°æ®å·è¢«åˆ é™¤**
3. **æ•°æ®è¢«è¯¯åˆ **

**è§£å†³æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ä»½
ls -lh /docker/db_master/backups/

# 2. æ¢å¤æœ€æ–°å¤‡ä»½
gunzip -c /docker/db_master/backups/postgres_full_20241003.sql.gz | \
  docker exec -i postgres_master psql -U admin -d postgres

# 3. å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼Œæ£€æŸ¥Dockerå·
docker volume ls | grep postgres

# 4. æŒ‚è½½æ—§çš„æ•°æ®å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# ä¿®æ”¹ docker-compose.vps.yml ä¸­çš„å·åç§°
```

**é¢„é˜²æªæ–½ï¼š**

```bash
# è®¾ç½®è‡ªåŠ¨å¤‡ä»½
cat > /docker/db_master/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/docker/db_master/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å…¨åº“å¤‡ä»½
docker exec postgres_master pg_dumpall -U admin | \
  gzip > $BACKUP_DIR/postgres_full_${DATE}.sql.gz

# åªä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "âœ… å¤‡ä»½å®Œæˆ: postgres_full_${DATE}.sql.gz"
EOF

chmod +x /docker/db_master/backup.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½ï¼‰
crontab -e
# æ·»åŠ : 0 3 * * * /docker/db_master/backup.sh
```

---

### é—®é¢˜2: æ•°æ®ä¸ä¸€è‡´

**ç—‡çŠ¶ï¼š**ç”¨æˆ·æ•°æ®ä¸åé¦ˆæ•°æ®ä¸åŒ¹é…

**è¯Šæ–­ï¼š**

```bash
# æ£€æŸ¥å­¤ç«‹çš„åé¦ˆï¼ˆuser_id ä¸å­˜åœ¨ï¼‰
docker exec postgres_master psql -U admin -d postgres -c "
SELECT COUNT(*) 
FROM unified_feedback f
LEFT JOIN colormagic_users u ON f.user_id = u.id
WHERE f.user_id IS NOT NULL AND u.id IS NULL;
"

# æ£€æŸ¥å¤–é”®çº¦æŸ
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND tc.table_name LIKE 'colormagic_%';
"
```

---

## ğŸ“ å†å²é—®é¢˜è®°å½•

### å·²è§£å†³çš„é‡å¤§é—®é¢˜

#### 1. Site3 æƒé™é—®é¢˜ï¼ˆ2024-10-02ï¼‰

**é—®é¢˜**ï¼šSite3 ç”¨æˆ·æ— æ³•è®¿é—® site3__users è¡¨

**ç—‡çŠ¶**ï¼š
```
ERROR: permission denied for table site3__users
```

**æ ¹æœ¬åŸå› **ï¼š
1. DO ä»£ç å—åœ¨æŸäº› shell ç¯å¢ƒä¸‹é™é»˜å¤±è´¥
2. GRANT å‘½ä»¤æœªçœŸæ­£æ‰§è¡Œ

**æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**ï¼š
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"
```

**ç»éªŒæ•™è®­**ï¼š
- é¿å…ä½¿ç”¨ heredoc å’Œ DO ä»£ç å—
- ä½¿ç”¨ç®€å•ç›´æ¥çš„ `-c` å‚æ•°æ‰§è¡Œå‘½ä»¤
- æ¯æ­¥éƒ½éªŒè¯è¾“å‡ºï¼Œç¡®ä¿å‘½ä»¤çœŸæ­£æ‰§è¡Œ

---

#### 2. ColorMagic wwwå­åŸŸå CORS é”™è¯¯ï¼ˆ2024-09-30ï¼‰

**é—®é¢˜**ï¼šhttps://www.imagecolorpicker.cc è¢« CORS é˜»æ­¢

**ç—‡çŠ¶**ï¼š
- âœ… https://imagecolorpicker.cc æ­£å¸¸
- âŒ https://www.imagecolorpicker.cc è¿”å› 500 é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä¿®æ”¹ä»£ç **ï¼ˆæœ¬åœ°ï¼‰ï¼š
```typescript
// backend/src/index.ts
const getAllowedOrigins = (): (string | RegExp)[] => {
  const origins: (string | RegExp)[] = []
  
  if (process.env.ALLOWED_ORIGINS) {
    const allowedOriginsArray = process.env.ALLOWED_ORIGINS.split(',').map(o => o.trim())
    origins.push(...allowedOriginsArray)
  }
  
  return origins
}
```

2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼ˆVPSï¼‰ï¼š
```env
ALLOWED_ORIGINS=https://imagecolorpicker.cc,https://www.imagecolorpicker.cc
```

3. **é‡æ–°éƒ¨ç½²**ï¼š
```bash
git pull origin main
cd backend && npm run build && cd ..
docker restart site4
```

**ç»éªŒæ•™è®­**ï¼š
- ä»£ç ä¿®æ”¹å¿…é¡»åœ¨æœ¬åœ°å®Œæˆ
- é€šè¿‡ Git åŒæ­¥åˆ° VPS
- ä¸è¦åœ¨ VPS ç›´æ¥ä¿®æ”¹ä»£ç 

---

#### 3. PostgreSQL è¡¨å­—æ®µç¼ºå¤±ï¼ˆ2024-10-01ï¼‰

**é—®é¢˜**ï¼š`colormagic_color_analysis` è¡¨ç¼ºå°‘å­—æ®µ

**ç¼ºå°‘å­—æ®µ**ï¼š
- `processed_width`
- `processed_height`

**å½±å“**ï¼špostgresService.ts æ’å…¥æ•°æ®å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä¿®æ”¹ `init-scripts/02_site4_colormagic.sql` ç¬¬133-134è¡Œï¼š
```sql
CREATE TABLE IF NOT EXISTS colormagic_color_analysis (
    id SERIAL PRIMARY KEY,
    analysis_id VARCHAR(100) UNIQUE NOT NULL,
    user_id UUID REFERENCES colormagic_users(id) ON DELETE SET NULL,
    image_name VARCHAR(255),
    image_size_bytes INTEGER,
    original_width INTEGER,
    original_height INTEGER,
    processed_width INTEGER,      -- âœ… æ·»åŠ æ­¤å­—æ®µ
    processed_height INTEGER,     -- âœ… æ·»åŠ æ­¤å­—æ®µ
    extracted_colors JSONB,
    -- ...
);
```

**ç»éªŒæ•™è®­**ï¼š
- ä»£ç å’Œæ•°æ®åº“è¡¨ç»“æ„å¿…é¡»ä¸€è‡´
- ä¿®æ”¹è¡¨ç»“æ„åéœ€è¦é‡æ–°åˆå§‹åŒ–æˆ–æ‰§è¡Œ ALTER TABLE

---

#### 4. çƒ­é—¨é¢œè‰²å‡½æ•°ç¼ºå¤±ï¼ˆ2024-10-01ï¼‰

**é—®é¢˜**ï¼šç¼ºå°‘ `get_colormagic_popular_colors()` å‡½æ•°

**å½±å“**ï¼šgetPopularColors() è°ƒç”¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

åœ¨ `init-scripts/02_site4_colormagic.sql` æ·»åŠ å‡½æ•°ï¼š
```sql
CREATE OR REPLACE FUNCTION get_colormagic_popular_colors(p_limit INTEGER)
RETURNS TABLE(
    hex_color VARCHAR,
    color_name VARCHAR,
    usage_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    WITH color_usage AS (
        SELECT jsonb_array_elements(palette) AS color_obj
        FROM colormagic_color_analysis
        WHERE created_at > NOW() - INTERVAL '30 days'
    )
    SELECT 
        (color_obj->>'hex')::VARCHAR AS hex_color,
        (color_obj->>'name')::VARCHAR AS color_name,
        COUNT(*)::BIGINT AS usage_count
    FROM color_usage
    WHERE color_obj->>'hex' IS NOT NULL
    GROUP BY color_obj->>'hex', color_obj->>'name'
    ORDER BY usage_count DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

### å¸¸è§é™·é˜±æ€»ç»“

| é™·é˜± | è¡¨ç° | é¿å…æ–¹æ³• |
|-----|------|---------|
| DO ä»£ç å—é™é»˜å¤±è´¥ | æƒé™æœªæˆäºˆ | ä½¿ç”¨ç®€å•çš„ `-c` å‘½ä»¤ |
| è¡¨åä¸åŒ¹é… | è¡¨ä¸å­˜åœ¨é”™è¯¯ | ç»Ÿä¸€ä½¿ç”¨å¸¦å‰ç¼€çš„è¡¨å |
| ç½‘ç»œæœªè¿æ¥ | æ— æ³•è¿æ¥æ•°æ®åº“ | ç¡®ä¿åº”ç”¨åœ¨ shared_net ä¸­ |
| å¯†ç ä¸æ­£ç¡® | è®¤è¯å¤±è´¥ | æ£€æŸ¥ .env æ–‡ä»¶å¯†ç  |
| ç«¯å£å†²çª | å®¹å™¨å¯åŠ¨å¤±è´¥ | ä¿®æ”¹ç«¯å£æ˜ å°„ |
| æ•°æ®å·å†²çª | åˆå§‹åŒ–è„šæœ¬æœªæ‰§è¡Œ | åˆ é™¤æ—§å·é‡æ–°åˆå§‹åŒ– |

---

## ğŸ› ï¸ è¯Šæ–­å·¥å…·è„šæœ¬

### å®Œæ•´è¯Šæ–­è„šæœ¬

```bash
cat > /docker/db_master/diagnose.sh << 'EOF'
#!/bin/bash

echo "=========================================="
echo "PostgreSQL æ€»ç³»ç»Ÿ - å®Œæ•´è¯Šæ–­"
echo "=========================================="
echo ""

# 1. å®¹å™¨çŠ¶æ€
echo "1ï¸âƒ£  å®¹å™¨çŠ¶æ€:"
docker ps | grep postgres_master
if [ $? -eq 0 ]; then
    echo "âœ… å®¹å™¨è¿è¡Œä¸­"
else
    echo "âŒ å®¹å™¨æœªè¿è¡Œ"
    docker ps -a | grep postgres_master
fi
echo ""

# 2. æ•°æ®åº“è¿æ¥
echo "2ï¸âƒ£  æ•°æ®åº“è¿æ¥:"
docker exec postgres_master psql -U admin -d postgres -c "SELECT version();" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
else
    echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
fi
echo ""

# 3. è¡¨æ£€æŸ¥
echo "3ï¸âƒ£  è¡¨æ£€æŸ¥:"
TABLE_COUNT=$(docker exec postgres_master psql -U admin -d postgres -t -c "SELECT COUNT(*) FROM pg_tables WHERE schemaname = 'public';" 2>/dev/null | tr -d ' ')
echo "æ•°æ®åº“è¡¨æ•°é‡: $TABLE_COUNT"
echo ""

# 4. ç”¨æˆ·æ£€æŸ¥
echo "4ï¸âƒ£  ç”¨æˆ·æ£€æŸ¥:"
USER_COUNT=$(docker exec postgres_master psql -U admin -d postgres -t -c "SELECT COUNT(*) FROM pg_user WHERE usename LIKE '%_user' OR usename = 'admin';" 2>/dev/null | tr -d ' ')
echo "ç³»ç»Ÿç”¨æˆ·æ•°é‡: $USER_COUNT"
echo ""

# 5. ç½‘ç»œæ£€æŸ¥
echo "5ï¸âƒ£  ç½‘ç»œæ£€æŸ¥:"
docker network inspect shared_net > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… shared_net ç½‘ç»œå­˜åœ¨"
    CONTAINER_COUNT=$(docker network inspect shared_net | grep -c '"Name":')
    echo "ç½‘ç»œä¸­çš„å®¹å™¨æ•°: $CONTAINER_COUNT"
else
    echo "âŒ shared_net ç½‘ç»œä¸å­˜åœ¨"
fi
echo ""

# 6. ç£ç›˜ç©ºé—´
echo "6ï¸âƒ£  ç£ç›˜ç©ºé—´:"
DB_SIZE=$(docker exec postgres_master psql -U admin -d postgres -t -c "SELECT pg_size_pretty(pg_database_size('postgres'));" 2>/dev/null | tr -d ' ')
echo "æ•°æ®åº“å¤§å°: $DB_SIZE"
echo ""

# 7. è¿æ¥æ•°
echo "7ï¸âƒ£  æ•°æ®åº“è¿æ¥:"
docker exec postgres_master psql -U admin -d postgres -c "
SELECT usename, COUNT(*) as connections 
FROM pg_stat_activity 
GROUP BY usename;
" 2>/dev/null
echo ""

# 8. æœ€è¿‘é”™è¯¯
echo "8ï¸âƒ£  æœ€è¿‘çš„é”™è¯¯æ—¥å¿—:"
docker logs postgres_master --tail 10 2>&1 | grep -i "error\|fatal\|fail"
echo ""

echo "=========================================="
echo "è¯Šæ–­å®Œæˆ"
echo "=========================================="
EOF

chmod +x /docker/db_master/diagnose.sh
```

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd /docker/db_master
./diagnose.sh
```

---

## ğŸ“ è·å–å¸®åŠ©

### 1. æŸ¥çœ‹æ—¥å¿—

```bash
# PostgreSQL æ—¥å¿—
docker logs postgres_master --tail 100
docker logs postgres_master -f  # å®æ—¶æŸ¥çœ‹

# åº”ç”¨æ—¥å¿—
docker logs your-app --tail 100
```

### 2. è¿›å…¥æ•°æ®åº“æ£€æŸ¥

```bash
# ä½¿ç”¨ admin ç”¨æˆ·
docker exec -it postgres_master psql -U admin -d postgres

# å¸¸ç”¨å‘½ä»¤ï¼š
\dt                    # åˆ—å‡ºæ‰€æœ‰è¡¨
\dt colormagic_*       # åˆ—å‡º ColorMagic è¡¨
\d colormagic_users    # æŸ¥çœ‹è¡¨ç»“æ„
\du                    # åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
\q                     # é€€å‡º
```

### 3. è¿è¡Œè¯Šæ–­è„šæœ¬

```bash
cd /docker/db_master
./diagnose.sh
```

### 4. å‚è€ƒç›¸å…³æ–‡æ¡£

- **ç³»ç»Ÿéƒ¨ç½²**: `README.md`
- **åº”ç”¨æ¥å…¥**: `åº”ç”¨æ¥å…¥PostgreSQLæ€»ç³»ç»ŸæŒ‡å—.md`
- **æ•°æ®æŸ¥çœ‹**: `VPSæŸ¥çœ‹åé¦ˆè¡¨å’Œæ³¨å†Œè¡¨æŒ‡å—.md`
- **è¡¨ç»“æ„**: `ColorMagicæ•°æ®åº“ç»“æ„è¯¦è§£.md`

---

## ğŸ“ æœ€ä½³å®è·µå»ºè®®

### 1. ä»£ç ä¿®æ”¹æµç¨‹

```
æœ¬åœ°å¼€å‘ â†’ æœ¬åœ°æµ‹è¯• â†’ Git æäº¤ â†’ VPS æ‹‰å– â†’ é‡æ–°æ„å»º â†’ éƒ¨ç½²
```

**âŒ ä¸è¦ï¼š**
- åœ¨ VPS ç›´æ¥ä¿®æ”¹ä»£ç æ–‡ä»¶
- è®©ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶åˆ° VPS
- è·³è¿‡æœ¬åœ°ç¼–è¯‘å’Œæµ‹è¯•

**âœ… è¦ï¼š**
- æ‰€æœ‰ä»£ç ä¿®æ”¹åœ¨æœ¬åœ°å®Œæˆ
- é€šè¿‡ Git åŒæ­¥åˆ° VPS
- åœ¨ VPS åªä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆ.envï¼‰

### 2. æƒé™ç®¡ç†

**åˆ›å»ºæ–°ç«™ç‚¹æ—¶ï¼š**
1. å…ˆåˆ›å»ºè¡¨
2. ç«‹å³æˆäºˆæƒé™
3. éªŒè¯æƒé™
4. å†éƒ¨ç½²åº”ç”¨

### 3. å¤‡ä»½ç­–ç•¥

- æ¯å¤©è‡ªåŠ¨å¤‡ä»½
- ä¿ç•™æœ€è¿‘ 7 å¤©å¤‡ä»½
- é‡è¦æ“ä½œå‰æ‰‹åŠ¨å¤‡ä»½

### 4. ç›‘æ§

- å®šæœŸæ£€æŸ¥å¾…å¤„ç†åé¦ˆ
- ç›‘æ§æ•°æ®åº“å¤§å°
- ç›‘æ§è¿æ¥æ•°

---

**ç‰ˆæœ¬**: v3.0  
**åˆ›å»ºæ—¥æœŸ**: 2024-10-03  
**åŸºäºæ–‡æ¡£**ï¼š
- ISSUES_AND_FIXES.md
- æƒé™é—®é¢˜å¿«é€Ÿè§£å†³æ–¹æ¡ˆ.md
- æ›´æ–°æ—¥å¿—-æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ.md

**çŠ¶æ€**: âœ… å·²æ•´åˆå¹¶éªŒè¯

---

**ç¥æ’æŸ¥é¡ºåˆ©ï¼** ğŸš€

