# PostgreSQL 总系统 - 故障排查与问题解决指南

> **综合维修文档**  
> **版本**: v3.0  
> **最后更新**: 2024-10-03  
> **适用系统**: PostgreSQL 总系统 v2.0+

---

## 📋 目录

1. [快速诊断流程](#快速诊断流程)
2. [权限问题解决方案](#权限问题解决方案)
3. [数据库连接问题](#数据库连接问题)
4. [表结构问题](#表结构问题)
5. [代码适配问题](#代码适配问题)
6. [部署问题](#部署问题)
7. [性能问题](#性能问题)
8. [数据问题](#数据问题)
9. [历史问题记录](#历史问题记录)

---

## 🚨 快速诊断流程

遇到问题时，请按以下顺序诊断：

### 第一步：确定问题类型

```bash
# 1. 检查容器是否运行
docker ps | grep postgres_master

# 2. 查看最近的错误日志
docker logs postgres_master --tail 50

# 3. 检查网络连接
docker network inspect shared_net | grep postgres
```

### 第二步：根据错误信息分类

| 错误信息 | 问题类型 | 跳转章节 |
|---------|---------|---------|
| `permission denied for table` | 权限问题 | [权限问题](#权限问题解决方案) |
| `getaddrinfo ENOTFOUND` | 网络问题 | [连接问题](#数据库连接问题) |
| `relation "xxx" does not exist` | 表名问题 | [表结构问题](#表结构问题) |
| `password authentication failed` | 认证问题 | [连接问题](#数据库连接问题) |
| `connection pool exhausted` | 性能问题 | [性能问题](#性能问题) |

---

## 🔐 权限问题解决方案

### 问题症状

```
ERROR: permission denied for table xxx_users
ERROR: permission denied for table site3__users
ERROR: permission denied for sequence xxx_id_seq
```

### 🚀 快速解决（3步）⭐

#### 方法1: 使用自动化脚本（最推荐）

```bash
# 在 VPS 上执行
cd /docker/db_master
chmod +x scripts/fix-permissions.sh

# 修复权限（替换为你的用户名）
./scripts/fix-permissions.sh site3_user
./scripts/fix-permissions.sh colormagic_user
```

#### 方法2: 手动执行（快速有效）

```bash
# 一键授予所有权限（最简单）
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"

docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"

# 验证权限
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"
```

**预期输出：**
```
 count 
-------
     0
(1 row)
```

#### 方法3: 完整重置（如果以上方法无效）

```bash
# 设置变量
SITE_USER="site3_user"
SITE_PASSWORD="site3_prod_pass_2024"

# 完全重置用户和权限
docker exec postgres_master psql -U admin -d postgres -c "
-- 撤销旧权限
REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM $SITE_USER;
REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public FROM $SITE_USER;

-- 删除并重新创建用户
DROP USER IF EXISTS $SITE_USER;
CREATE USER $SITE_USER WITH PASSWORD '$SITE_PASSWORD';

-- 授予基础权限
GRANT CONNECT ON DATABASE postgres TO $SITE_USER;
GRANT USAGE ON SCHEMA public TO $SITE_USER;

-- 授予表和序列权限
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"

# 测试
docker exec postgres_master psql -U $SITE_USER -d postgres -c "SELECT current_user, COUNT(*) FROM site3__users;"
```

---

### 📊 权限诊断流程

#### 1. 检查用户是否存在

```bash
docker exec postgres_master psql -U admin -d postgres -c "\du site3_user"
```

**预期输出：**
```
      Role name       |  Attributes  
----------------------+--------------
 site3_user           |              
```

**如果不存在**，需要先创建：
```bash
docker exec postgres_master psql -U admin -d postgres -c "
CREATE USER site3_user WITH PASSWORD 'site3_prod_pass_2024';
"
```

---

#### 2. 检查表是否存在

```bash
docker exec postgres_master psql -U admin -d postgres -c "\dt site3__*"
```

**如果表不存在**，需要先创建表（运行应用的初始化脚本）。

---

#### 3. 检查当前权限

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT grantee, table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' AND table_name LIKE 'site3__%'
ORDER BY table_name;
"
```

**如果返回 0 行**，说明没有权限，需要授权。

---

#### 4. 检查表的所有者

```bash
docker exec postgres_master psql -U admin -d postgres -c "
SELECT schemaname, tablename, tableowner 
FROM pg_tables 
WHERE tablename LIKE 'site3__%';
"
```

**所有者应该是 `admin`**。如果不是，可能导致权限问题。

---

### ✅ 完整验证检查清单

执行以下所有测试，确认权限完全正常：

```bash
# ✅ 1. 用户可以连接
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT current_user;"

# ✅ 2. 用户可以读取表
docker exec postgres_master psql -U site3_user -d postgres -c "SELECT COUNT(*) FROM site3__users;"

# ✅ 3. 用户可以插入数据
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO site3__users (username, email, password_hash) 
VALUES ('testuser', 'test@site3.com', 'test123') 
ON CONFLICT (email) DO NOTHING;
"

# ✅ 4. 用户可以更新数据
docker exec postgres_master psql -U site3_user -d postgres -c "
UPDATE site3__users SET password_hash = 'new_hash' WHERE username = 'testuser';
"

# ✅ 5. 用户可以访问 unified_feedback
docker exec postgres_master psql -U site3_user -d postgres -c "
INSERT INTO unified_feedback (site_id, content, category) 
VALUES ('site3', '测试反馈', 'test') 
RETURNING id, site_id, content;
"

# ✅ 6. 查看所有权限
docker exec postgres_master psql -U admin -d postgres -c "
SELECT DISTINCT table_name 
FROM information_schema.table_privileges 
WHERE grantee = 'site3_user' 
ORDER BY table_name;
"
```

**如果以上 6 个测试都通过，权限配置完全正常！** ✅

---

### 🎯 不同站点的权限修复命令

#### Site3
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"
```

#### ColorMagic (Site4)
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO colormagic_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO colormagic_user;"
```

#### Site1
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site1_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site1_user;"
```

---

### ❌ 常见错误和原因

#### 错误1: DO 代码块不执行

**症状**：运行 DO 代码块后没有任何输出

**原因**：某些 shell 环境中，heredoc 方式的 DO 代码块可能静默失败

**解决**：使用 `-c` 参数直接执行简单的 GRANT 命令

```bash
# ❌ 可能失败
docker exec postgres_master psql -U admin -d postgres << 'EOF'
DO $$
BEGIN
    GRANT ALL PRIVILEGES ON site3__users TO site3_user;
END $$;
EOF

# ✅ 推荐方式
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
```

---

#### 错误2: GRANT 命令没有输出

**症状**：执行 GRANT 后没有看到 "GRANT" 字样

**原因**：命令可能没有真正执行

**解决**：确保使用 `-c` 参数，并检查返回码

```bash
# 正确的执行方式
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"

# 应该看到输出：
# GRANT
```

---

#### 错误3: 权限查询返回 0 行

**症状**：
```sql
SELECT grantee, table_name FROM information_schema.table_privileges WHERE grantee = 'site3_user';
-- 返回 0 rows
```

**原因**：权限确实没有授予成功

**解决**：重新执行授权命令，并确保看到 "GRANT" 输出

---

### 💡 预防措施

#### 在创建新站点表时，立即授权

```bash
# 创建表后立即授权
SITE_USER="site5_user"

# 执行初始化脚本创建表
cat init-site5.sql | docker exec -i postgres_master psql -U admin -d postgres

# 立即授权
docker exec postgres_master psql -U admin -d postgres -c "
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $SITE_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $SITE_USER;
"
```

---

## 🔌 数据库连接问题

### 问题1: 无法连接到 postgres_master

**症状：**
```
Error: getaddrinfo ENOTFOUND postgres_master
```

**原因**：应用容器不在 `shared_net` 网络中

**解决步骤：**

```bash
# 1. 检查 shared_net 网络是否存在
docker network ls | grep shared_net

# 如果不存在，创建它
docker network create shared_net

# 2. 检查应用容器是否在网络中
docker network inspect shared_net | grep -A 5 your-app

# 3. 如果没有，连接网络
docker network connect shared_net your-app

# 4. 重启应用
docker restart your-app

# 5. 测试 DNS 解析
docker exec your-app ping -c 2 postgres_master

# 6. 测试端口连接
docker exec your-app nc -zv postgres_master 5432
```

---

### 问题2: 密码认证失败

**症状：**
```
Error: password authentication failed for user "colormagic_user"
```

**原因**：`.env` 文件中的密码不正确

**解决步骤：**

```bash
# 1. 检查 .env 密码
cat /docker/your-app/.env | grep DB_PASSWORD

# 2. 检查 PostgreSQL 中的正确密码
# 应该是：ColorMagic_VPS_2024_Secure_Pass（Site4）
# 或：site1_prod_pass_2024（Site1）

# 3. 更新 .env 文件
nano /docker/your-app/.env
# 修改 DB_PASSWORD=正确的密码

# 4. 重启应用
docker restart your-app

# 5. 查看日志验证
docker logs your-app --tail 30
```

**或者重置 PostgreSQL 中的密码：**

```bash
# 重置密码
docker exec postgres_master psql -U admin -d postgres -c "
ALTER USER colormagic_user WITH PASSWORD 'NewPassword123';
"

# 同步更新应用的.env文件
```

---

### 问题3: 连接池耗尽

**症状：**
```
Error: remaining connection slots are reserved
Error: connection pool exhausted
```

**原因**：连接数超过限制

**解决步骤：**

```bash
# 1. 检查当前连接数
docker exec postgres_master psql -U admin -d postgres -c "
SELECT count(*) as connections, usename 
FROM pg_stat_activity 
GROUP BY usename;
"

# 2. 减少应用的连接池大小
nano /docker/your-app/.env
# 修改：DB_MAX_CONNECTIONS=10

# 3. 清理空闲连接
docker exec postgres_master psql -U admin -d postgres -c "
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'idle' AND state_change < now() - interval '5 minutes';
"

# 4. 增加 PostgreSQL 最大连接数（如需要）
# 编辑 docker-compose.vps.yml，修改 max_connections

# 5. 重启应用
docker restart your-app
```

---

### 问题4: 端口连接失败

**症状：**
```
Error: connect ECONNREFUSED 5432
```

**解决步骤：**

```bash
# 1. 检查 PostgreSQL 容器是否运行
docker ps | grep postgres_master

# 2. 检查端口映射
docker port postgres_master

# 3. 检查防火墙设置（如果从外部连接）
sudo ufw status
sudo ufw allow 5432/tcp

# 4. 检查 PostgreSQL 监听配置
docker exec postgres_master psql -U admin -d postgres -c "SHOW listen_addresses;"

# 5. 重启 PostgreSQL 容器
docker restart postgres_master
```

---

## 📋 表结构问题

### 问题1: 表不存在

**症状：**
```
Error: relation "users" does not exist
Error: relation "colormagic_users" does not exist
```

**原因及解决：**

#### 原因1: 代码中使用了不带前缀的表名

```javascript
// ❌ 错误代码
const query = 'SELECT * FROM users';  

// ✅ 修改为
const query = 'SELECT * FROM colormagic_users';  

// 💡 或使用配置
const { TABLES } = require('./config/database');
const query = `SELECT * FROM ${TABLES.USERS}`;
```

#### 原因2: 初始化脚本未执行

```bash
# 1. 检查表是否存在
docker exec postgres_master psql -U admin -d postgres -c "\dt colormagic_*"

# 2. 如果没有表，检查初始化日志
docker logs postgres_master | grep -i "初始化\|creating\|created"

# 3. 完全重新初始化（会删除所有数据！）
docker compose -f docker-compose.vps.yml down -v
docker volume rm postgres_master_postgres_data
docker compose -f docker-compose.vps.yml up -d

# 4. 或手动执行初始化脚本
cat init-scripts/02_site4_colormagic.sql | \
  docker exec -i postgres_master psql -U admin -d postgres
```

---

### 问题2: 字段不存在

**症状：**
```
Error: column "processed_width" does not exist
```

**解决：**

```bash
# 1. 查看表结构
docker exec postgres_master psql -U admin -d postgres -c "\d colormagic_color_analysis"

# 2. 如果缺少字段，添加字段
docker exec postgres_master psql -U admin -d postgres -c "
ALTER TABLE colormagic_color_analysis 
ADD COLUMN processed_width INTEGER,
ADD COLUMN processed_height INTEGER;
"

# 3. 验证字段已添加
docker exec postgres_master psql -U admin -d postgres -c "\d colormagic_color_analysis"
```

---

### 问题3: 表名不匹配

**症状：**应用正常运行但数据没有保存

**原因：**代码中的表名与数据库实际表名不一致

**检查和修复：**

```bash
# 1. 列出所有表
docker exec postgres_master psql -U admin -d postgres -c "\dt"

# 2. 检查代码中使用的表名
grep -r "FROM.*users" backend/src/  # 搜索代码中的表名

# 3. 确保表名映射正确
```

**Site4 (ColorMagic) 表名映射：**

| 代码中可能的表名 | PostgreSQL 实际表名 |
|----------------|-------------------|
| `users` | `colormagic_users` |
| `sessions` | `colormagic_sessions` |
| `analysis_history` | `colormagic_color_analysis` |
| `user_analysis_history` | `colormagic_analysis_history` |
| `palettes` | `colormagic_palettes` |
| `feedback` | `unified_feedback` (WHERE site_id='colormagic') |

---

## 💻 代码适配问题

### 问题1: authService.ts 表名不匹配

**影响**：用户认证系统完全无法工作

**错误的表名：**
- `users` → 应该是 `colormagic_users`
- `user_sessions` → 应该是 `colormagic_sessions`
- `user_analysis_history` → 应该是 `colormagic_analysis_history`
- `user_favorite_palettes` → 应该是 `colormagic_palettes`
- `user_usage_stats` → 应该是 `colormagic_usage_stats`

**修复方法（本地操作）：**

```bash
# 在本地开发环境
cd backend/src/services/auth

# 备份原文件
cp authService.ts authService.ts.backup

# 批量替换表名
sed -i 's/FROM users/FROM colormagic_users/g' authService.ts
sed -i 's/INSERT INTO users/INSERT INTO colormagic_users/g' authService.ts
sed -i 's/UPDATE users/UPDATE colormagic_users/g' authService.ts
sed -i 's/user_sessions/colormagic_sessions/g' authService.ts
sed -i 's/user_analysis_history/colormagic_analysis_history/g' authService.ts
sed -i 's/user_favorite_palettes/colormagic_palettes/g' authService.ts
sed -i 's/user_usage_stats/colormagic_usage_stats/g' authService.ts

# 编译 TypeScript
cd ../../../
npm run build

# Git 提交
git add .
git commit -m "fix: update table names to match PostgreSQL schema"
git push origin main

# VPS 上拉取更新
# 在 VPS 执行：
# cd /docker/site4
# git pull origin main
# cd backend && npm run build && cd ..
# docker restart site4
```

---

### 问题2: postgresService.ts 插入错误的表

**影响**：颜色分析记录保存失败

**错误位置**：`backend/src/services/database/postgresService.ts` 第116行

**错误代码：**
```typescript
INSERT INTO colormagic_analysis_history (...)  // ❌ 错误的表
```

**正确代码：**
```typescript
INSERT INTO colormagic_color_analysis (...)  // ✅ 正确的表
```

**原因说明：**
- `colormagic_analysis_history` - 用户关联的分析历史（需要user_id）
- `colormagic_color_analysis` - 独立的颜色分析记录（支持匿名访问）

postgresService.ts 的 saveColorAnalysis 应该使用后者。

**修复步骤：**

```bash
# 本地修改
nano backend/src/services/database/postgresService.ts

# 第116行，修改表名
# INSERT INTO colormagic_analysis_history
# 改为
# INSERT INTO colormagic_color_analysis

# 编译
npm run build

# 提交
git add .
git commit -m "fix: correct table name in postgresService"
git push

# VPS 部署
# ...
```

---

### 问题3: 反馈表 site_id 未设置

**症状**：查询到其他站点的反馈数据

**原因**：查询时未过滤 `site_id`

**错误代码：**
```javascript
// ❌ 错误：没有过滤 site_id
const query = 'SELECT * FROM unified_feedback';
```

**正确代码：**
```javascript
// ✅ 正确：必须过滤 site_id
const siteId = process.env.SITE_ID || 'colormagic';
const query = 'SELECT * FROM unified_feedback WHERE site_id = $1';
const result = await db.query(query, [siteId]);
```

---

## 🚀 部署问题

### 问题1: 容器启动失败

**症状：**容器启动后立即退出

**诊断步骤：**

```bash
# 1. 查看容器状态
docker ps -a | grep postgres

# 2. 查看详细日志
docker logs postgres_master --tail 100

# 3. 查看容器退出代码
docker inspect postgres_master | grep -A 5 "State"
```

**常见原因及解决：**

#### 原因1: 端口冲突

```bash
# 检查端口占用
sudo lsof -i :5432
sudo netstat -tulpn | grep 5432

# 解决方法1: 修改端口
# 编辑 docker-compose.vps.yml
ports:
  - "5433:5432"  # 改为5433或其他端口

# 解决方法2: 停止占用端口的服务
sudo systemctl stop postgresql  # 如果是系统自带的PostgreSQL
```

#### 原因2: 数据卷冲突

```bash
# 删除旧的数据卷
docker compose down -v
docker volume rm postgres_master_postgres_data

# 重新启动
docker compose -f docker-compose.vps.yml up -d
```

#### 原因3: 内存不足

```bash
# 检查系统内存
free -h

# 检查Docker内存限制
docker stats postgres_master

# 如果内存不足，清理系统
docker system prune -a
```

---

### 问题2: 初始化脚本未执行

**症状：**容器运行正常，但表不存在

**原因：**Docker卷已存在数据，初始化脚本被跳过

**解决：**

```bash
# 方法1: 完全重新初始化（会删除所有数据！）
docker compose down -v
docker volume rm postgres_master_postgres_data
docker compose -f docker-compose.vps.yml up -d

# 方法2: 手动执行初始化脚本
cd /docker/db_master
cat init-scripts/01_unified_feedback.sql | docker exec -i postgres_master psql -U admin -d postgres
cat init-scripts/02_site4_colormagic.sql | docker exec -i postgres_master psql -U admin -d postgres
cat init-scripts/03_sites_and_functions.sql | docker exec -i postgres_master psql -U admin -d postgres
```

---

### 问题3: 应用无法连接数据库（网络问题）

**症状：**应用启动正常，但无法连接数据库

**诊断和解决：**

```bash
# 1. 检查网络
docker network inspect shared_net

# 2. 检查应用是否在网络中
docker network inspect shared_net | grep your-app

# 3. 连接网络
docker network connect shared_net your-app

# 4. 测试连接
docker exec your-app ping -c 2 postgres_master
docker exec your-app nc -zv postgres_master 5432

# 5. 检查应用环境变量
docker exec your-app env | grep DB_

# 6. 重启应用
docker restart your-app
```

---

### 问题4: 健康检查失败

**症状：**容器不断重启

**诊断：**

```bash
# 查看健康检查状态
docker inspect postgres_master | grep -A 10 "Health"

# 查看日志
docker logs postgres_master --tail 50
```

**解决：**

```bash
# 手动执行健康检查命令
docker exec postgres_master pg_isready -U admin -d postgres

# 如果失败，检查PostgreSQL是否正常启动
docker exec postgres_master psql -U admin -d postgres -c "SELECT version();"
```

---

## ⚡ 性能问题

### 问题1: 查询速度慢

**诊断：**

```bash
# 查看慢查询
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    pid,
    now() - query_start as duration,
    query
FROM pg_stat_activity
WHERE state = 'active' AND query NOT LIKE '%pg_stat_activity%'
ORDER BY duration DESC;
"
```

**解决：**

```bash
# 1. 分析表统计信息
docker exec postgres_master psql -U admin -d postgres -c "ANALYZE;"

# 2. 查看缺失的索引
docker exec postgres_master psql -U admin -d postgres -c "
SELECT schemaname, tablename 
FROM pg_tables 
WHERE schemaname = 'public';
"

# 3. 为常用查询字段添加索引
docker exec postgres_master psql -U admin -d postgres -c "
CREATE INDEX idx_custom ON colormagic_users(email);
"
```

---

### 问题2: 数据库过大

**诊断：**

```bash
# 查看数据库大小
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;
"

# 查看表大小
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
"
```

**解决：**

```bash
# 1. 清理过期会话
docker exec postgres_master psql -U admin -d postgres -c "SELECT cleanup_expired_sessions();"

# 2. 清理死行（VACUUM）
docker exec postgres_master psql -U admin -d postgres -c "VACUUM;"

# 3. 归档旧数据（示例：归档30天前的反馈）
docker exec postgres_master psql -U admin -d postgres -c "
DELETE FROM unified_feedback 
WHERE status = 'resolved' 
  AND created_at < NOW() - INTERVAL '30 days';
"

# 4. 完全清理和分析（需要停机维护时间）
docker exec postgres_master psql -U admin -d postgres -c "VACUUM FULL ANALYZE;"
```

---

## 📊 数据问题

### 问题1: 数据丢失

**症状：**之前的数据突然消失

**可能原因：**

1. **容器被删除并重建**
2. **数据卷被删除**
3. **数据被误删**

**解决步骤：**

```bash
# 1. 检查是否有备份
ls -lh /docker/db_master/backups/

# 2. 恢复最新备份
gunzip -c /docker/db_master/backups/postgres_full_20241003.sql.gz | \
  docker exec -i postgres_master psql -U admin -d postgres

# 3. 如果没有备份，检查Docker卷
docker volume ls | grep postgres

# 4. 挂载旧的数据卷（如果存在）
# 修改 docker-compose.vps.yml 中的卷名称
```

**预防措施：**

```bash
# 设置自动备份
cat > /docker/db_master/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/docker/db_master/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 全库备份
docker exec postgres_master pg_dumpall -U admin | \
  gzip > $BACKUP_DIR/postgres_full_${DATE}.sql.gz

# 只保留最近7天的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "✅ 备份完成: postgres_full_${DATE}.sql.gz"
EOF

chmod +x /docker/db_master/backup.sh

# 添加到crontab（每天凌晨3点备份）
crontab -e
# 添加: 0 3 * * * /docker/db_master/backup.sh
```

---

### 问题2: 数据不一致

**症状：**用户数据与反馈数据不匹配

**诊断：**

```bash
# 检查孤立的反馈（user_id 不存在）
docker exec postgres_master psql -U admin -d postgres -c "
SELECT COUNT(*) 
FROM unified_feedback f
LEFT JOIN colormagic_users u ON f.user_id = u.id
WHERE f.user_id IS NOT NULL AND u.id IS NULL;
"

# 检查外键约束
docker exec postgres_master psql -U admin -d postgres -c "
SELECT 
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND tc.table_name LIKE 'colormagic_%';
"
```

---

## 📝 历史问题记录

### 已解决的重大问题

#### 1. Site3 权限问题（2024-10-02）

**问题**：Site3 用户无法访问 site3__users 表

**症状**：
```
ERROR: permission denied for table site3__users
```

**根本原因**：
1. DO 代码块在某些 shell 环境下静默失败
2. GRANT 命令未真正执行

**最终解决方案**：
```bash
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO site3_user;"
docker exec postgres_master psql -U admin -d postgres -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO site3_user;"
```

**经验教训**：
- 避免使用 heredoc 和 DO 代码块
- 使用简单直接的 `-c` 参数执行命令
- 每步都验证输出，确保命令真正执行

---

#### 2. ColorMagic www子域名 CORS 错误（2024-09-30）

**问题**：https://www.imagecolorpicker.cc 被 CORS 阻止

**症状**：
- ✅ https://imagecolorpicker.cc 正常
- ❌ https://www.imagecolorpicker.cc 返回 500 错误

**解决方案**：

1. **修改代码**（本地）：
```typescript
// backend/src/index.ts
const getAllowedOrigins = (): (string | RegExp)[] => {
  const origins: (string | RegExp)[] = []
  
  if (process.env.ALLOWED_ORIGINS) {
    const allowedOriginsArray = process.env.ALLOWED_ORIGINS.split(',').map(o => o.trim())
    origins.push(...allowedOriginsArray)
  }
  
  return origins
}
```

2. **配置环境变量**（VPS）：
```env
ALLOWED_ORIGINS=https://imagecolorpicker.cc,https://www.imagecolorpicker.cc
```

3. **重新部署**：
```bash
git pull origin main
cd backend && npm run build && cd ..
docker restart site4
```

**经验教训**：
- 代码修改必须在本地完成
- 通过 Git 同步到 VPS
- 不要在 VPS 直接修改代码

---

#### 3. PostgreSQL 表字段缺失（2024-10-01）

**问题**：`colormagic_color_analysis` 表缺少字段

**缺少字段**：
- `processed_width`
- `processed_height`

**影响**：postgresService.ts 插入数据失败

**解决方案**：

修改 `init-scripts/02_site4_colormagic.sql` 第133-134行：
```sql
CREATE TABLE IF NOT EXISTS colormagic_color_analysis (
    id SERIAL PRIMARY KEY,
    analysis_id VARCHAR(100) UNIQUE NOT NULL,
    user_id UUID REFERENCES colormagic_users(id) ON DELETE SET NULL,
    image_name VARCHAR(255),
    image_size_bytes INTEGER,
    original_width INTEGER,
    original_height INTEGER,
    processed_width INTEGER,      -- ✅ 添加此字段
    processed_height INTEGER,     -- ✅ 添加此字段
    extracted_colors JSONB,
    -- ...
);
```

**经验教训**：
- 代码和数据库表结构必须一致
- 修改表结构后需要重新初始化或执行 ALTER TABLE

---

#### 4. 热门颜色函数缺失（2024-10-01）

**问题**：缺少 `get_colormagic_popular_colors()` 函数

**影响**：getPopularColors() 调用失败

**解决方案**：

在 `init-scripts/02_site4_colormagic.sql` 添加函数：
```sql
CREATE OR REPLACE FUNCTION get_colormagic_popular_colors(p_limit INTEGER)
RETURNS TABLE(
    hex_color VARCHAR,
    color_name VARCHAR,
    usage_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    WITH color_usage AS (
        SELECT jsonb_array_elements(palette) AS color_obj
        FROM colormagic_color_analysis
        WHERE created_at > NOW() - INTERVAL '30 days'
    )
    SELECT 
        (color_obj->>'hex')::VARCHAR AS hex_color,
        (color_obj->>'name')::VARCHAR AS color_name,
        COUNT(*)::BIGINT AS usage_count
    FROM color_usage
    WHERE color_obj->>'hex' IS NOT NULL
    GROUP BY color_obj->>'hex', color_obj->>'name'
    ORDER BY usage_count DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

### 常见陷阱总结

| 陷阱 | 表现 | 避免方法 |
|-----|------|---------|
| DO 代码块静默失败 | 权限未授予 | 使用简单的 `-c` 命令 |
| 表名不匹配 | 表不存在错误 | 统一使用带前缀的表名 |
| 网络未连接 | 无法连接数据库 | 确保应用在 shared_net 中 |
| 密码不正确 | 认证失败 | 检查 .env 文件密码 |
| 端口冲突 | 容器启动失败 | 修改端口映射 |
| 数据卷冲突 | 初始化脚本未执行 | 删除旧卷重新初始化 |

---

## 🛠️ 诊断工具脚本

### 完整诊断脚本

```bash
cat > /docker/db_master/diagnose.sh << 'EOF'
#!/bin/bash

echo "=========================================="
echo "PostgreSQL 总系统 - 完整诊断"
echo "=========================================="
echo ""

# 1. 容器状态
echo "1️⃣  容器状态:"
docker ps | grep postgres_master
if [ $? -eq 0 ]; then
    echo "✅ 容器运行中"
else
    echo "❌ 容器未运行"
    docker ps -a | grep postgres_master
fi
echo ""

# 2. 数据库连接
echo "2️⃣  数据库连接:"
docker exec postgres_master psql -U admin -d postgres -c "SELECT version();" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ 数据库连接正常"
else
    echo "❌ 数据库连接失败"
fi
echo ""

# 3. 表检查
echo "3️⃣  表检查:"
TABLE_COUNT=$(docker exec postgres_master psql -U admin -d postgres -t -c "SELECT COUNT(*) FROM pg_tables WHERE schemaname = 'public';" 2>/dev/null | tr -d ' ')
echo "数据库表数量: $TABLE_COUNT"
echo ""

# 4. 用户检查
echo "4️⃣  用户检查:"
USER_COUNT=$(docker exec postgres_master psql -U admin -d postgres -t -c "SELECT COUNT(*) FROM pg_user WHERE usename LIKE '%_user' OR usename = 'admin';" 2>/dev/null | tr -d ' ')
echo "系统用户数量: $USER_COUNT"
echo ""

# 5. 网络检查
echo "5️⃣  网络检查:"
docker network inspect shared_net > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ shared_net 网络存在"
    CONTAINER_COUNT=$(docker network inspect shared_net | grep -c '"Name":')
    echo "网络中的容器数: $CONTAINER_COUNT"
else
    echo "❌ shared_net 网络不存在"
fi
echo ""

# 6. 磁盘空间
echo "6️⃣  磁盘空间:"
DB_SIZE=$(docker exec postgres_master psql -U admin -d postgres -t -c "SELECT pg_size_pretty(pg_database_size('postgres'));" 2>/dev/null | tr -d ' ')
echo "数据库大小: $DB_SIZE"
echo ""

# 7. 连接数
echo "7️⃣  数据库连接:"
docker exec postgres_master psql -U admin -d postgres -c "
SELECT usename, COUNT(*) as connections 
FROM pg_stat_activity 
GROUP BY usename;
" 2>/dev/null
echo ""

# 8. 最近错误
echo "8️⃣  最近的错误日志:"
docker logs postgres_master --tail 10 2>&1 | grep -i "error\|fatal\|fail"
echo ""

echo "=========================================="
echo "诊断完成"
echo "=========================================="
EOF

chmod +x /docker/db_master/diagnose.sh
```

**使用方法：**
```bash
cd /docker/db_master
./diagnose.sh
```

---

## 📞 获取帮助

### 1. 查看日志

```bash
# PostgreSQL 日志
docker logs postgres_master --tail 100
docker logs postgres_master -f  # 实时查看

# 应用日志
docker logs your-app --tail 100
```

### 2. 进入数据库检查

```bash
# 使用 admin 用户
docker exec -it postgres_master psql -U admin -d postgres

# 常用命令：
\dt                    # 列出所有表
\dt colormagic_*       # 列出 ColorMagic 表
\d colormagic_users    # 查看表结构
\du                    # 列出所有用户
\q                     # 退出
```

### 3. 运行诊断脚本

```bash
cd /docker/db_master
./diagnose.sh
```

### 4. 参考相关文档

- **系统部署**: `README.md`
- **应用接入**: `应用接入PostgreSQL总系统指南.md`
- **数据查看**: `VPS查看反馈表和注册表指南.md`
- **表结构**: `ColorMagic数据库结构详解.md`

---

## 🎓 最佳实践建议

### 1. 代码修改流程

```
本地开发 → 本地测试 → Git 提交 → VPS 拉取 → 重新构建 → 部署
```

**❌ 不要：**
- 在 VPS 直接修改代码文件
- 让用户手动上传文件到 VPS
- 跳过本地编译和测试

**✅ 要：**
- 所有代码修改在本地完成
- 通过 Git 同步到 VPS
- 在 VPS 只修改配置文件（.env）

### 2. 权限管理

**创建新站点时：**
1. 先创建表
2. 立即授予权限
3. 验证权限
4. 再部署应用

### 3. 备份策略

- 每天自动备份
- 保留最近 7 天备份
- 重要操作前手动备份

### 4. 监控

- 定期检查待处理反馈
- 监控数据库大小
- 监控连接数

---

**版本**: v3.0  
**创建日期**: 2024-10-03  
**基于文档**：
- ISSUES_AND_FIXES.md
- 权限问题快速解决方案.md
- 更新日志-权限问题解决方案.md

**状态**: ✅ 已整合并验证

---

**祝排查顺利！** 🚀

